---
title: "Appendix 2"
output: pdf_document
date: "2025-11-18"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, messages = FALSE, warning = FALSE)

library(tidyverse)
library(sf)
library(nimble)
# remotes::install_github("rileymummah/SpFut.flexiSDM", build_vignettes = T)
library(SpFut.flexiSDM)
```

<!-- ## --------------------------- -->
<!-- ## Objective: -->
<!-- ##    - Imports species and covariate data -->
<!-- ##    - Scales covariates -->
<!-- ##    - Sets up data for NIMBLE -->
<!-- ## -->
<!-- ## Input: -->
<!-- ##    - functions/FXN-MVPv1.1.R -->
<!-- ##    - code/03-species-models/MVPv1.csv -->
<!-- ## -->
<!-- ## Output: -->
<!-- ##    - setup_BLOCK.rdata (saves environment for import to fit model) -->
<!-- ## -->
<!-- ## --------------------------- -->

So you wanna fit an integrated species distribution model? You've come to the right place!

# NEED SOME SORT OF INTRO HERE.

<!-- # summarize datasets to get up-to-date available datasets -->
<!-- # this script also prints messages from QC functions -->
<!-- # source("DATA SWAMP/00-summarize-datasets.R") -- needed load_species_data() -->

Let's first load the libraries we'll need to set up, visualize, fit, and summarize our data.

```{r libraries, eval = F}
# Load libraries ----
library(tidyverse)
library(sf)
library(nimble)

## To install SpFut.flexiSDM or check for updates, use the commented code below:
# remotes::install_github("rileymummah/SpFut.flexiSDM", build_vignettes = T)
library(SpFut.flexiSDM)

```


# WHERE/HOW TO INTRODUCE RUNNING THIS ON AN HPC

<!-- # DO NOT EDIT BELOW HERE ---- -->
<!-- args = commandArgs(trailingOnly = TRUE) -->

<!-- if (length(args) > 0) { -->

<!--   # Number of model to run -->
<!--   nums.do = as.numeric(args[1]) -->

<!--   # Assign a block to run if running locally -->
<!--   block = as.numeric(args[2]) -->

<!--   if (block == 4) { -->
<!--     block <- 'none' -->
<!--   }   -->

<!--   # Running locally? Yes = 1 -->
<!--   local = as.numeric(args[3]) -->

<!--   if (local == 0) { -->
<!--     setwd('/caldera/hovenweep/projects/usgs/ecosystems/eesc/rmummah/species-futures/') -->
<!--   }  -->
<!-- }  -->

To load data or fit a model, you must first create a .csv file that outlines the model specifications. We call ours `model-specs.csv`. Let's load the .csv and take a look at how we structured it.

```{r model-specs}
mods <- read.csv("code/model-specs.csv")

head(mods, n=2)
```

# INSERT TABLE DESCRIBING WHAT EACH COLUMN IS AND WHY IT'S INCLUDED IN THE .CSV

We have set up the scripts in the flexiSDM workflow so that a minimum number of parameters needs to be changed among them. To run this script in full (using our file arrangement), you only need to edit the following parameters:

```{r param.edit}
nums.do <- 2 # model number to run
block <- 'none' # block to run ('none', 1, 2, or 3)
local <- 1 # are you running the code locally (1) or on an HPC (0)?
a <- 1 # Fixed for indexing a vector below
```


Then we can use our model specifications to define a series of inputs for the setup script (found in `01-flexiSDM.R`).

```{r mods}
## Set up model variables
mods <- filter(mods, number %in% nums.do)

## Create all the combinations of model number and cross-validation block
tmp <- expand.grid(block.out = block, number = unique(mods$number))
mods <- full_join(mods, tmp, by = c("number"))
# CAN WE SIMPLIFY THIS SO THE CODE ONLY RUNS ONE MODEL NUMBER-BLOCK COMBO?
# THEN WE COULD REMOVE 'A' BELOW AND FIX IT AT 1

## Get variables for model from MVPv1.csv
number <- mods$number[a] # model number
sp.code <- mods$sp.code[a] # 4-digit species code
model <- mods$model[a] # model name
sp.auto <- mods$sp.auto[a] # include spatial autocorrelation?
coarse.grid <- mods$coarse.grid[a] # use a coarse grid?
cont.grid <- mods$cont.grid[a] # restrict to only a continuous grid?
year.start <- mods$year.start[a] # start year for data
year.end <- mods$year.end[a] # end year for data
buffer <- mods$buffer[a] # buffer size (km)
filter.region <- mods$filter.region[a]
spat.bal <- mods$spat.bal[a] # include spatial balancing?
coordunc <- mods$coordunc[a] # level of coordinate uncertainty to include (km)
coordunc_na.rm <- mods$coordunc_na.rm[a] # filter by coordinate uncertainty?
block.folds <- mods$block.folds[a] # how many groups of blocks?
block.rows <- mods$block.rows[a] # how many rows of blocks?
block.cols <- mods$block.cols[a] # how many columns of blocks?
block.out <- mods$block.out[a]

if (block.out == "none") {
  blockname <- "full" # rename the block to 'full' if not doing cross-validation
} else {blockname <- block.out} # otherwise, keep the block number

# names of datasets to exclude (e.g., iNaturalist) - must match dataset naming
exclude.dataset <- unlist(str_split(mods$exclude.dataset[a], pattern = ", "))

## ICAR parameters
zero_mean <- mods$zero_mean[a] # zero mean assumption?
tau <- mods$tau[a] # precision (tau) can be a fixed value or a prior

## MCMC parameters
iter <- mods$iter[a] # number of MCMC iterations
thin <- mods$thin[a] # number to thin by
burnin <- floor(iter*0.75) # burnin to discard

## Change of region
region.sub <- mods$region.sub[a] # only estimate for a subregion?
lat.hi <- mods$lat.hi[a] # high value of latitude range
lat.lo <- mods$lat.lo[a] # low value of latitude range
lon.hi <- mods$lon.hi[a] # high value of longitude range
lon.lo <- mods$lon.lo[a] # low value of longitude range

## Future projections
project <- mods$project[a] # how many projections?
if (block.out != "none") {
  project <- 0 # no projections for cross-validation blocks
}

## Covariates
# list of PO covariates
covs.PO <- unlist(str_split(mods$covs.PO[a], pattern = ", "))
# list of iNaturalist covariates
covs.inat <- unlist(str_split(mods$covs.inat[a], pattern = ", "))
# list of linear covariates for state model
covs.lin <- unlist(str_split(mods$covs.lin[a], pattern = ", "))
# list of quadratic covariates for state model
covs.quad <- unlist(str_split(mods$covs.quad[a], pattern = ", "))

# SHOULD WE KEEP THIS IN? WE'RE NOT CURRENTLY USING IT BUT COULD??
# covs.int.factor <- unlist(str_split(mods$covs.int.factor[a], pattern = ", "))
# reference <- mods$reference[a]
# covs.int.cont <- unlist(str_split(mods$covs.int.cont[a], pattern = ", "))
check.covs <- mods$check.covs[a] # covariate selection to remove multicollinearity?

# Define the prior for the state model coefficients
Bpriordist <- mods$Bpriordist[a]
Bpriorvar1 <- mods$Bpriorvar1[a]
Bpriorvar2 <- mods$Bpriorvar2[a]
# WE COULD SIMPLIFY THIS TO LOOK LIKE TAU

process.intercept <- F # SHOULD RENAME TO state.intercept??
```




<!-- codeKey <- read.csv("code/02-species-data-and-ranges/model-specieslist.csv") -->
<!-- common <- codeKey %>% -->
<!--   filter(DS.code == sp.code) %>% -->
<!--   pull(SSAR.common) -->
<!-- sp.code.all <- codeKey %>% -->
<!--   filter(DS.code == sp.code) %>% -->
<!--   pull(all.codes) -->
<!-- sciname <- codeKey %>% -->
<!--   filter(DS.code == sp.code) %>% -->
<!--   pull(SSAR.scientific) -->

<!-- gen <- stringr::word(sciname, 1) -->

<!-- if (gen %in% c("Acris", "Anaxyrus", "Aquarana", "Ascaphus",  -->
<!--                "Craugastor", "Dendrobates", "Dryophytes", "Eleutherodactylus", -->
<!--                "Gastrophryne", "Glandirana", "Hyla", "Hypopachus", "Incilius", -->
<!--                "Leptodactylus", "Lithobates", "Osteopilus", -->
<!--                "Pseudacris", "Rana", "Rhinella", "Rhinophrynus", -->
<!--                "Scaphiopus", "Smilisca", "Spea", "Xenopus")) spp.type <- "Frog/Toad" -->
<!-- if (gen %in% c("Ambystoma", "Amphiuma", "Aneides", "Batrachoseps", -->
<!--                "Cryptobranchus", "Desmognathus", "Dicamptodon",  -->
<!--                "Ensatina", "Eurycea", "Gyrinophilus", "Hemidactylium", -->
<!--                "Hydromantes", "Necturus", "Notophthalmus", -->
<!--                "Phaeognathus", "Plethodon", "Pseudobranchus", -->
<!--                "Pseudotriton", "Rhyacotriton", "Siren",  -->
<!--                "Stereochilus", "Taricha", "Urspelerpes")) spp.type <- "Salamander" -->




Now that we have our model specifications loaded, we're ready to start loading data and covariates. First, let's ensure that we have an output folder specific to the model we are fitting.

```{r output-folder}
# Make output folder ----
out.dir <- paste0("outputs/", number, "_", sp.code, "_", model, "/")
if (dir.exists(out.dir) == F) {
  dir.create(out.dir)
}
```

Step 1: Define the region

We define the region of inference using the GAP and IUCN ranges. Other boundaries could be used to create the limits of the range. We 

```{r ranges}
# Load ranges
range.path <- c(paste0("data/species/", sp.code, "/GAP/"),
                paste0("data/species/", sp.code, "/IUCN/"))
range.name <- c("GAP", "IUCN")
rangelist <- get_range(range.path,
                       range.name,
                       crs = 4326)
```

<!-- # USA boundary -->
<!-- exclude <- c("Alaska", "Hawaii", "Commonwealth of the Northern Mariana Islands", -->
<!--              "American Samoa", "United States Virgin Islands", "Guam", "Puerto Rico") -->
<!-- usa <- st_read("data/USA/maps/cb_2018_us_state_500k/cb_2018_us_state_500k.shp") %>% -->
<!--         filter((NAME %in% exclude) == F) %>% -->
<!--         st_union() -->
<!-- # CONUS grid -->
<!-- load("data/USA/grid-covar.rdata") -->

<!-- # Region -->
<!-- region <- make_region(rangelist, -->
<!--                       buffer = buffer, -->
<!--                       crs = 3857, -->
<!--                       sub = region.sub, -->
<!--                       boundary = usa, -->
<!--                       grid = conus.grid, -->
<!--                       rm.clumps = T, -->
<!--                       clump.size = 50, -->
<!--                       continuous = cont.grid) -->



<!-- # Set up cross validation blocks ---- -->
<!-- # sb <- cv_spatial(x = region$sp.grid,  -->
<!-- #                  rows_cols = c(block.rows, block.cols), -->
<!-- #                  k = block.folds,  -->
<!-- #                  hexagon = F,  -->
<!-- #                  selection = "systematic",  -->
<!-- #                  biomod2 = F,  -->
<!-- #                  plot = F,  -->
<!-- #                  report = F) -->
<!-- spatblocks <- make_CV_blocks(region, rows = block.rows, cols = block.cols, k = block.folds) -->



<!-- # Set up training and test sets based on cross validation blocks -->
<!-- if (block.out == "none") { -->
<!--   test.i <- c() -->
<!--   train.i <- region$sp.grid$conus.grid.id -->

<!-- } else { -->
<!--   block1 <- spatblocks %>% -->
<!--     filter(folds == block.out) -->

<!--   # find grid.ids for test block, everything else is train -->
<!--   test.i1 <- st_intersection(region$sp.grid, block1) -->
<!--   test.i <- st_intersection(region$sp.grid, block1) %>% -->
<!--     pull(conus.grid.id) %>% -->
<!--     unique() -->
<!--   train.i <- filter(region$sp.grid, conus.grid.id %in% test.i == F) %>% -->
<!--     pull(conus.grid.id) -->

<!-- } -->



<!-- # Make gridkey ---- -->
<!-- gridkey <- select(region$sp.grid, conus.grid.id) %>% -->
<!--   st_drop_geometry() %>% -->
<!--   mutate(group = case_when(conus.grid.id %in% train.i ~ "train", -->
<!--                            conus.grid.id %in% test.i ~ "test")) -->


<!-- if (coarse.grid == T) { -->
<!--   spatRegion <- suppressWarnings(make_spatkey(region$sp.grid)) -->

<!--   # Print spatial grid -->
<!--   if (block.out == 'none') { -->
<!--     pl <- ggplot(spatRegion$spat.grid) + geom_sf() + theme_bw() -->
<!--     ggsave(pl, file = paste0(out.dir, "2_inputmap-e_spatGrid.jpg"), height = 8, width = 10) -->
<!--   } -->
<!-- } else { -->
<!--   spatRegion <- NULL -->
<!-- } -->


<!-- # Species data ---- -->
<!-- # get all files that have data for that species -->
<!-- allfiles <- read.csv("DATA SWAMP/dataset-summary-full.csv") -->
<!-- tmp1 <- gsub("[|]", "$|^", sp.code.all) -->
<!-- tmp2 <- paste0("^", tmp1, "$") -->
<!-- allfiles <- allfiles[grep(tmp2, allfiles$species),] %>% -->
<!--   #select(-species, -percentdet) %>% -->
<!--   select(name, file) %>% -->
<!--   distinct() %>% -->
<!--   filter(name %in% exclude.dataset == F) -->

<!-- # detection covariates for each of these datasets -->
<!-- covs <- read.csv("DATA SWAMP/00-data-summary-flexiSDM.csv") %>% -->
<!--   filter(Data.Swamp.file.name %in% allfiles$file) %>% -->
<!--   select(Name, Covar.mean, Covar.sum, Area) -->
<!-- covariates <- list() -->
<!-- for (i in 1:nrow(covs)) { -->
<!--   covs.mean <- unlist(strsplit(covs$Covar.mean[i], split = ", ")) -->
<!--   covs.sum <- unlist(strsplit(covs$Covar.sum[i], split = ", ")) -->
<!--   #area <- unlist(strsplit(covs$Area[i], split = ",")) -->
<!--   covs1 <- c(covs.mean, covs.sum) -->
<!--   covs1 <- covs1[which(is.na(covs1) == F)] -->
<!--   covariates[[i]] <- covs1 -->
<!-- } -->

<!-- species.data <- load_species_data(sp.code, -->
<!--                                   sp.code.all, -->
<!--                                   file.name = allfiles$file, -->
<!--                                   file.label = allfiles$name, -->
<!--                                   file.path = "DATA SWAMP/data-ready/", -->
<!--                                   keep.cols = covariates, -->
<!--                                   region = region,  -->
<!--                                   filter.region = filter.region, -->
<!--                                   year.start = year.start, -->
<!--                                   year.end = year.end, -->
<!--                                   coordunc = coordunc, -->
<!--                                   coordunc_na.rm = coordunc_na.rm, -->
<!--                                   spat.thin = spat.bal, -->
<!--                                   keep.conus.grid.id = gridkey$conus.grid.id[which(gridkey$group == "train")]) -->



<!-- ### Plot species data ---- -->
<!-- if (block == "none") { -->
<!--   title <- ", full model" -->
<!-- } else { -->
<!--   title <- paste0(", excluding block ", block) -->
<!-- } -->

<!-- pl <- map_species_data(region = region, -->
<!--                        species.data = species.data, -->
<!--                        year.start = year.start, -->
<!--                        year.end = year.end, -->
<!--                        plot = "samples", -->
<!--                        plot.region = T, -->
<!--                        details = T, -->
<!--                        title = paste0(common, " (", sp.code, ")", title)) -->
<!-- ggsave(pl, file = paste0(out.dir, "2_inputmap-b_data-", blockname, "-details.jpg"), height = 8, width = 10) -->

<!-- pl <- map_species_data(region = region, -->
<!--                        species.data = species.data, -->
<!--                        year.start = year.start, -->
<!--                        year.end = year.end, -->
<!--                        plot = "samples", -->
<!--                        plot.region = T, -->
<!--                        details = F, -->
<!--                        title = paste0(common, " (", sp.code, ")", title)) -->
<!-- ggsave(pl, file = paste0(out.dir, "2_inputmap-a_data-", blockname, ".jpg"), height = 8, width = 10) -->


<!-- if (block.out != "none") { -->

<!--   pl <- map_species_data(region = region, -->
<!--                          species.data = species.data, -->
<!--                          year.start = year.start, -->
<!--                          year.end = year.end, -->
<!--                          plot = "samples", -->
<!--                          plot.blocks = T, -->
<!--                          blocks = spatblocks[which(spatblocks$folds == block),], -->
<!--                          plot.region = T, -->
<!--                          details = T, -->
<!--                          title = paste0(common, " (", sp.code, ")", title)) -->
<!--   ggsave(pl, file = paste0(out.dir, "2_inputmap-d_blocks-", blockname, "-details.jpg"), height = 8, width = 10) -->

<!--   pl <- map_species_data(region = region, -->
<!--                          species.data = species.data, -->
<!--                          year.start = year.start, -->
<!--                          year.end = year.end, -->
<!--                          plot = "samples", -->
<!--                          plot.blocks = T, -->
<!--                          blocks = spatblocks[which(spatblocks$folds == block),], -->
<!--                          plot.region = T, -->
<!--                          details = F, -->
<!--                          title = paste0(common, " (", sp.code, ")", title)) -->
<!--   ggsave(pl, file = paste0(out.dir, "2_inputmap-c_blocks-", blockname, ".jpg"), height = 8, width = 10) -->


<!-- } else { -->
<!--   pl <- map_species_data(region = region, -->
<!--                          species.data = species.data, -->
<!--                          year.start = year.start, -->
<!--                          year.end = year.end, -->
<!--                          plot = "samples", -->
<!--                          plot.blocks = T, -->
<!--                          blocks = spatblocks, -->
<!--                          plot.region = T, -->
<!--                          details = T, -->
<!--                          title = paste0(common, " (", sp.code, ")", title)) -->
<!--   ggsave(pl, file = paste0(out.dir, "2_inputmap-d_blocks-", blockname, "-details.jpg"), height = 8, width = 10) -->

<!--   pl <- map_species_data(region = region, -->
<!--                          species.data = species.data, -->
<!--                          year.start = year.start, -->
<!--                          year.end = year.end, -->
<!--                          plot = "samples", -->
<!--                          plot.blocks = T, -->
<!--                          blocks = spatblocks, -->
<!--                          plot.region = T, -->
<!--                          details = F, -->
<!--                          title = paste0(common, " (", sp.code, ")", title)) -->
<!--   ggsave(pl, file = paste0(out.dir, "2_inputmap-c_blocks-", blockname, ".jpg"), height = 8, width = 10) -->

<!-- } -->



<!-- # Covariate data ---- -->
<!-- load("data/USA/grid-covar.rdata") -->
<!-- covar <- conus.covar.grid %>% filter(conus.grid.id %in% region$sp.grid$conus.grid.id) -->
<!-- covar <- covar[order(match(covar$conus.grid.id, region$sp.grid$conus.grid.id)),] -->

<!-- # load iNat data for similar species if it exists -->
<!-- if ("iNaturalist" %in% names(species.data$obs)) { -->
<!--   cat("loading iNat records of supplemental species\n") -->

<!--   inat <- readRDS("data/USA/inateffortcov.rds") %>% -->
<!--     mutate(conus.grid.id = as.character(conus.grid.id)) -->

<!--   covar <- dplyr::left_join(covar, inat, by = c("conus.grid.id")) -->

<!--   # Assign Frog or Salamander iNat counts -->
<!--   if (spp.type == 'Frog/Toad') { -->
<!--     covar$n.inat <- covar$n.frog -->
<!--   } else { -->
<!--     covar$n.inat <- covar$n.sal -->
<!--   } -->

<!--   covar <- select(covar, -n.frog, -n.sal) -->


<!--   # Now check if records for this species need to be added -->

<!--   # read in all inat data for this species -->
<!--   dat <- read.csv(paste0("DATA SWAMP/data-ready/", gen, "_iNat_PO.csv")) %>% -->
<!--     filter(year >= 1994, year <= 2025) -->
<!--   tmp1 <- gsub("[|]", "$|^", sp.code.all) -->
<!--   tmp2 <- paste0("^", tmp1, "$") -->
<!--   dat <- dat[grep(tmp2, dat$species),] -->


<!--   # files <- list.files("../species-futures/DATA SWAMP/data-ready/", pattern = "_iNat_PO.csv") -->
<!--   # fs <- files[grep(sp.code.all, files)] -->
<!--   # if (length(fs) == 0) next -->
<!--   # inat.dat1 <- c() -->
<!--   # for (f in 1:length(fs)) { -->
<!--   #    -->
<!--   #   dat <- read.csv(paste0("../species-futures/DATA SWAMP/data-ready/", fs[f])) %>% -->
<!--   #     filter(year >= year.start, year <= year.end) -->
<!--   #    -->
<!--   #   # iNaturalist records for subspecies names might be duplicates, remove here -->
<!--   #   new <- paste0(dat$lat, dat$lon, dat$day, dat$month, dat$year) -->
<!--   #   old <- paste0(inat.dat1$lat, inat.dat1$lon, inat.dat1$day, inat.dat1$month, inat.dat1$year) -->
<!--   #    -->
<!--   #   if (length(old) > 0) { -->
<!--   #     rm <- which(new %in% old) -->
<!--   #     dat <- dat[-rm,] -->
<!--   #      -->
<!--   #     if (nrow(dat) == 0) { -->
<!--   #       #cat("All iNaturalist records are potential duplicates\n") -->
<!--   #       next -->
<!--   #     } else { -->
<!--   #       inat.dat1 <- bind_rows(inat.dat1, dat) -->
<!--   #     } -->
<!--   #   } else { -->
<!--   #     inat.dat1 <- bind_rows(inat.dat1, dat) -->
<!--   #   } -->
<!--   # } # end loading inat files -->


<!--   # if all points in a state are obscured (coord.unc > 25000), species was not included -->
<!--   tmp <- dat %>% -->
<!--     group_by(stateProvince) %>% -->
<!--     summarize(min.unc = min(coord.unc, na.rm = T)) %>% -->
<!--     mutate(min.unc = case_when(min.unc == Inf ~ NA, -->
<!--                                T ~ min.unc)) %>% -->
<!--     filter(min.unc > 25000) -->
<!--   obsc.state <- tmp$stateProvince -->
<!--   statecodes <- read.csv("data/statecodes.csv") -->
<!--   obsc.state <- statecodes$abbrev[which(statecodes$state %in% obsc.state)] -->


<!--   # species was already included -->
<!--   if (nrow(tmp) == 0) { -->


<!--     # Need to add species -->
<!--   } else { -->
<!--     cat("Adding", sp.code, "to iNat effort covariate\n") -->

<!--     inat.cells <- dat %>% -->
<!--       st_as_sf(coords = c("lon", "lat"), crs = 4326) %>% -->
<!--       st_transform(crs = 3857) %>% -->
<!--       st_intersection(region$sp.grid) %>% -->
<!--       st_drop_geometry() %>% -->
<!--       group_by(conus.grid.id) %>% -->
<!--       summarize(n.inat.sp = n()) %>% -->
<!--       full_join(region$sp.grid, ., by = "conus.grid.id") %>% -->
<!--       st_drop_geometry() -->
<!--     inat.cells$n.inat.sp[is.na(inat.cells$n.inat.sp)] <- 0 -->

<!--     covar <- full_join(covar, select(inat.cells, conus.grid.id, n.inat.sp), by = 'conus.grid.id') %>% -->
<!--       mutate(n.inat = n.inat + n.inat.sp) -->
<!--   } -->

<!-- } -->






<!-- # add centroid lat and lon of each grid cell to covar -->
<!-- centroid <- sf::st_centroid(region$sp.grid) %>% -->
<!--               sf::st_coordinates() %>% -->
<!--               as.data.frame() %>% -->
<!--               dplyr::mutate(conus.grid.id = region$sp.grid$conus.grid.id) -->

<!-- colnames(centroid)[1:2] <- c("lon", "lat") -->
<!-- covar <- dplyr::left_join(covar, centroid, by = "conus.grid.id") -->



<!-- ### Read in process covariates ---- -->
<!-- covs.z <- c(covs.lin, covs.quad, covs.int.factor) -->
<!-- if ("" %in% covs.z) { -->
<!--   covs.z <- covs.z[-which(covs.z == "")]   -->
<!-- } -->
<!-- if (NA %in% covs.z) { -->
<!--   covs.z <- covs.z[-which(is.na(covs.z))] -->
<!-- } -->



<!-- ### Add additional/derived covariates ----- -->
<!-- # If you add a new covariate, add a row to data/covariate-labels.csv with a label -->
<!-- if (sp.code == "ANMI") { # add in additional ANMI covariates -->

<!--   inv <- read_rds("data/species/ANMI/invsp-grid.rds") %>% -->
<!--     mutate(CRAY01 = case_when(CRAY_huc10 > 0 ~ 1, -->
<!--                               CRAY_huc10 == 0 ~ 0), -->
<!--            BULL01 = BULL_huc10, -->
<!--            FISH01 = case_when(FISH_huc10 > 0 ~ 1, -->
<!--                               FISH_huc10 == 0 ~ 0), -->
<!--            nonnative = CRAY01 + BULL01 + FISH01) -->
<!--   flow <- read_rds("data/species/ANMI/flow-grid.rds") -->
<!--   clade <- read_rds("data/species/ANMI/clade-grid.rds") -->
<!--   cwd <- read_rds("data/species/ANMI/cwd-grid.rds") -->
<!--   rip <- read_rds("data/species/ANMI/riparian-grid.rds") -->
<!--   rsvr <- read_rds("data/species/ANMI/rsvr-grid.rds") -->
<!--   aet <- read_rds("data/species/ANMI/aet-grid.rds") -->
<!--   perm <- read_rds("data/species/ANMI/waterperm-grid.rds") -->

<!--   covar <- left_join(covar, select(inv, !sp.grid.id), by = c("conus.grid.id")) %>% -->
<!--             left_join(select(flow, !sp.grid.id), by = c("conus.grid.id")) %>% -->
<!--             left_join(select(perm, !sp.grid.id), by = c("conus.grid.id")) %>% -->
<!--             left_join(select(aet, !sp.grid.id), by = c("conus.grid.id")) %>% -->
<!--             left_join(select(cwd, !sp.grid.id), by = c("conus.grid.id")) %>% -->
<!--             left_join(select(rip, !sp.grid.id), by = c("conus.grid.id")) %>% -->
<!--             left_join(select(rsvr, !sp.grid.id), by = c("conus.grid.id")) %>% -->
<!--             mutate(riparian = stream_forest) %>% -->
<!--             mutate(sqrt.mean.spring.discharge = sqrt(mean.spring.discharge), -->
<!--                    curt.mean.spring.discharge = mean.spring.discharge^(1/3)) %>% -->
<!--             left_join(select(ungroup(clade), !sp.grid.id), by = c("conus.grid.id")) -->


<!-- } else if (sp.code == "RACA") { -->

<!--   rain <- read_rds("data/species/RACA/rain-grid.rds") -->

<!--   covar <- left_join(covar, select(rain, !sp.grid.id), by = c("conus.grid.id")) %>% -->
<!--             mutate(sqrtarea_small = sqrt(area_small), -->
<!--                    sqrtarea_medium = sqrt(area_medium)) -->



<!-- } else if (sp.code == "GPOR") { -->

<!--   cwd <- read_rds("data/species/GPOR/cwd-grid.rds") -->
<!--   rain <- read_rds("data/species/GPOR/rain-grid.rds") -->
<!--   soilwater <- read_rds("data/species/GPOR/soilwater-grid.rds") -->
<!--   climate_velocity <- read_rds("data/species/GPOR/climate_velocity.rds") -->

<!--   covar <- left_join(covar, select(cwd, !sp.grid.id), by = c("conus.grid.id")) %>% -->
<!--             left_join(select(rain, !sp.grid.id), by = c("conus.grid.id")) %>% -->
<!--             left_join(select(soilwater, !sp.grid.id), by = c("conus.grid.id")) %>% -->
<!--             left_join(select(climate_velocity, !sp.grid.id), by = c("conus.grid.id")) -->


<!-- } else if (sp.code == "PLSE") { -->

<!--   if (buffer == 1) regs <- c("east", "west", "west", "west", "west") -->
<!--   if (buffer == 100000) regs <- c("east", "west", "west") -->
<!--   reg <- region$region %>% -->
<!--           st_cast("POLYGON") %>% -->
<!--           mutate(region = regs) -->

<!--   grid <- region$sp.grid %>% -->
<!--           st_intersection(reg) %>% -->
<!--           st_drop_geometry() -->

<!--   covar <- covar %>% -->
<!--             mutate(N_all = N + NW + NE) %>% -->
<!--             full_join(grid, by = c("conus.grid.id")) -->



<!-- } -->

<!-- rm <- which(complete.cases(covar[,covs.z]) == F) -->
<!-- if (length(rm) > 0) { -->
<!--   covar <- covar[-rm,] -->
<!--   region$sp.grid <- region$sp.grid[-rm,] -->
<!--   gridkey <- gridkey[-rm,] -->
<!-- } -->

<!-- # for 143_DFUS -->
<!-- if (number == 143) { -->

<!--   tmp <- species.data$locs$disc %>% -->
<!--     filter(source == "iNaturalist") %>% -->
<!--     left_join(covar, by = "conus.grid.id") -->

<!--   rm <- which(covar$footprint > 30) -->

<!--   if (length(rm) > 0) { -->


<!--     # first remove these from region, then find and remove other island cells -->
<!--     new.grid <- region$sp.grid[-rm,] -->
<!--     tmp <- new.grid %>% -->
<!--       # group neighboring cells -->
<!--       dplyr::summarize(geometry = sf::st_union(geometry, by_feature = F)) %>% -->
<!--       sf::st_cast("POLYGON")  -->

<!--     if (cont.grid == T) { -->
<!--       tmp1 <- tmp %>%  -->
<!--         mutate(area = as.numeric(sf::st_area(geometry))) %>% -->
<!--         arrange(desc(area)) %>%  -->
<!--         slice(1) -->
<!--     } else { -->
<!--       tmp1 <- tmp %>%  -->
<!--         mutate(area = as.numeric(sf::st_area(geometry))) %>% -->
<!--         dplyr::filter(area > 24999998 * 50) -->
<!--     } -->

<!--     tmp2 <- st_intersection(new.grid, tmp1)  -->
<!--     region$sp.grid <- tmp2 -->



<!--     covar <- filter(covar, conus.grid.id %in% region$sp.grid$conus.grid.id) -->
<!--     gridkey <- filter(gridkey, conus.grid.id %in% region$sp.grid$conus.grid.id) -->



<!--     # now put everything back in the correct order -->
<!--     covar <- covar[order(match(covar$conus.grid.id, region$sp.grid$conus.grid.id)),] -->
<!--     gridkey <- gridkey[order(match(gridkey$conus.grid.id, region$sp.grid$conus.grid.id)),] -->


<!--     # # fix spatRegion -->
<!--     # spatRegion$spatkey <- filter(spatRegion$spatkey, conus.grid.id %in% region$sp.grid$conus.grid.id) -->
<!--     # spatRegion$spat.grid <- filter(spatRegion$spat.grid, spat.grid.id %in% spatRegion$spatkey$spat.grid.id) -->
<!--     # spatRegion$spat.grid$spat.grid.id.new <- 1:nrow(spatRegion$spat.grid) -->
<!--     # spatRegion$spatkey <- full_join(spatRegion$spatkey, spatRegion$spat.grid, by = "spat.grid.id") -->

<!--   } -->



<!-- } -->





<!-- ### Scale covariates ---- -->
<!-- covar_unscaled <- covar -->

<!-- # scale numeric cols -->
<!-- numcols <- sapply(covar, is.numeric) -->
<!-- numcols <- which(numcols) -->
<!-- covar[,numcols] <- sapply(covar[,numcols], scale_this) -->

<!-- # remove covariates that are correlated > 0.4 -->
<!-- if (check.covs == T){ -->

<!--   threshold <- 0.4 -->
<!--   if (sp.code == "PJOR") threshold <- 0.45 -->

<!--   covs.rm <- select_covar(covs.z, threshold = threshold) -->
<!--   covs.lin <- covs.lin[-which(covs.lin %in% covs.rm)] -->
<!--   covs.quad <- covs.quad[-which(covs.quad %in% covs.rm)] -->

<!--   covs.z <- c(covs.lin, covs.quad) -->
<!-- } -->

<!-- if (length(covs.z) < 3) { -->
<!--   stop("There are fewer than 3 covariates remaining! This probably isn't a good model") -->
<!-- } -->


<!-- ### Clean up PO covariates ---- -->
<!-- if (length(covs.inat) == 1) { -->
<!--   if (covs.inat == "" | is.na(covs.inat)) covs.inat <- NULL -->
<!-- } -->
<!-- if (length(covs.PO) == 1) { -->
<!--   if (covs.PO == "" | is.na(covs.PO)) covs.PO <- NULL -->
<!-- } -->


<!-- ### Plot covariates ---- -->
<!-- if (block.out == "none") { -->


<!--   # Process covs -->

<!--   # get covariate labels -->
<!--   covlabs <- read.csv("data/covariate-labels.csv") %>% filter(covariate %in% covs.z) -->

<!--   plot_covar(covar, -->
<!--              region, -->
<!--              cov.names = covlabs$covariate, -->
<!--              cov.labels = covlabs$Label, -->
<!--              out.path = out.dir, -->
<!--              out.name = "1_covariates-a_process-map") -->

<!--   cor_covar(covar,  -->
<!--             cov.names = covlabs$covariate, -->
<!--             cov.labels = covlabs$Label, -->
<!--             out.path = out.dir, -->
<!--             out.name = "1_covariates-a_process-correlations",  -->
<!--             color.threshold = 0.25) -->



<!--   # iNat covs -->

<!--   # get covariate labels -->

<!--   covlabs <- read.csv("data/covariate-labels.csv") %>% -->
<!--     filter(covariate %in% covs.inat) -->

<!--   if (length(covs.inat) > 0) { -->
<!--     plot_covar(covar, -->
<!--                region, -->
<!--                cov.names = covlabs$covariate, -->
<!--                cov.labels = covlabs$Label, -->
<!--                out.path = out.dir, -->
<!--                out.name = "1_covariates-b_iNat-map") -->

<!--     if (length(covs.inat) > 1) { -->
<!--       cor_covar(covar,  -->
<!--                 cov.names = covlabs$covariate, -->
<!--                 cov.labels = covlabs$Label, -->
<!--                 out.path = out.dir, -->
<!--                 out.name = "1_covariates-b_iNat-correlations",  -->
<!--                 color.threshold = 0.25) -->
<!--     } -->
<!--   } -->



<!--   # PO covs -->

<!--   # get covariate labels -->
<!--   covlabs <- read.csv("data/covariate-labels.csv") %>% -->
<!--     filter(covariate %in% covs.PO) -->

<!--   if (length(covs.PO)) { -->
<!--     plot_covar(covar, -->
<!--                region, -->
<!--                cov.names = covlabs$covariate, -->
<!--                cov.labels = covlabs$Label, -->
<!--                out.path = out.dir, -->
<!--                out.name = "1_covariates-c_PO-map") -->

<!--     if (length(covs.PO) > 1) { -->
<!--       cor_covar(covar,  -->
<!--                 cov.names = covlabs$covariate, -->
<!--                 cov.labels = covlabs$Label, -->
<!--                 out.path = out.dir, -->
<!--                 out.name = "1_covariates-c_PO-correlations",  -->
<!--                 color.threshold = 0.25) -->
<!--     } -->
<!--   } -->

<!-- } -->



<!-- ### Add quadratic covariates and interactions ---- -->
<!-- if (length(covs.quad) > 0 & paste0(covs.quad, collapse = "") != "") { -->
<!--   for (c in 1:length(covs.quad)) { -->
<!--     covar[,paste0(covs.quad[c], "2")] <- covar[,covs.quad[c]] * covar[,covs.quad[c]] -->
<!--     covs.z <- c(covs.z, paste0(covs.quad[c], "2")) -->
<!--   } -->
<!-- } -->

<!-- # and interactions -->
<!-- if (length(covs.int.factor) == 1 & is.na(covs.int.factor) == F) { -->

<!--   # pivot factor wider to get dummy cols -->
<!--   covar[,covs.int.factor] <- paste0(covs.int.factor, ".", covar[,covs.int.factor]) -->
<!--   covar <- covar %>% -->
<!--             mutate(fact = 1) %>% -->
<!--             pivot_wider(names_from = all_of(covs.int.factor), values_from = fact, values_fill = 0) -->

<!--   covs.z <- c(covs.z, colnames(covar)[grep(paste0(covs.int.factor, "."), colnames(covar))]) -->

<!--   for (j in 1:length(covs.int.cont)) { -->
<!--     # add interaction -->
<!--     tmp <- add_int_cols(covar, int.factor = covs.int.factor, int.cont = covs.int.cont[j]) -->
<!--     covar <- tmp$covar -->
<!--     covs.z <- c(covs.z, tmp$names) -->
<!--   } -->

<!--   # remove reference level -->
<!--   rm <- grep(reference, covs.z) -->
<!--   covs.z <- covs.z[-rm] -->

<!--   # remove original column name -->
<!--   rm <- grep(covs.int.factor, covs.z)[1] -->
<!--   covs.z <- covs.z[-rm] -->
<!-- } -->




<!-- # Make spatkey ---- -->

<!-- if (coarse.grid == T) { -->
<!--   spatRegion <- suppressWarnings(make_spatkey(region$sp.grid)) -->

<!--   # Print spatial grid -->
<!--   if (block.out == 'none') { -->
<!--     pl <- ggplot(spatRegion$spat.grid) + geom_sf() + theme_bw() -->
<!--     ggsave(pl, file = paste0(out.dir, "2_inputmap-e_spatGrid.jpg"), height = 8, width = 10) -->
<!--   } -->
<!-- } else { -->
<!--   spatRegion <- NULL -->
<!-- } -->






<!-- # NIMBLE ---- -->

<!-- # add grid.id to gridkey -->
<!-- gridkey$grid.id <- 1:nrow(gridkey) -->




<!-- summary <- read.csv("DATA SWAMP/00-data-summary-flexiSDM.csv") %>% -->
<!--             filter(Data.Swamp.file.name %in% allfiles$file, -->
<!--                    Name %in% names(species.data$obs)) %>% -->
<!--   select(-Data.Swamp.file.name) %>% -->
<!--   distinct() -->
<!-- summary <- summary[order(match(summary$Name, names(species.data$obs))),] %>% distinct() -->

<!-- sp.data <- sppdata_for_nimble(species.data, -->
<!--                               region, -->
<!--                               data.type = summary$Type.true, -->
<!--                               PO.extent = summary$PO.extent, -->
<!--                               covar = covar, -->
<!--                               covs.inat = covs.inat, -->
<!--                               covs.PO = covs.PO, -->
<!--                               covs.mean = summary$Covar.mean, -->
<!--                               covs.sum = summary$Covar.sum, -->
<!--                               offset.area = rep("", nrow(summary)), -->
<!--                               DND.maybe = 1, -->
<!--                               keep.conus.grid.id = gridkey$conus.grid.id[which(gridkey$group == "train")]) # get rid of PO cells that are in the wrong grid cells -->


<!-- ### Data/constants ---- -->
<!-- tmp <- data_for_nimble(sp.data, covar = covar, covs.z, -->
<!--                        sp.auto = sp.auto, coarse.grid = coarse.grid, region = region, -->
<!--                        process.intercept = process.intercept, -->
<!--                        gridkey = gridkey, spatRegion= spatRegion) -->

<!-- data <- tmp$data -->
<!-- constants <- tmp$constants -->


<!-- # Add state indicator variable for iNat data to indicate which states have taxon geoprivacy -->
<!-- # Add state indicator for multi-state PO to indicate which states have data -->
<!-- constants <- add_state_ind(species.data, -->
<!--                            region, -->
<!--                            gridkey, -->
<!--                            constants, -->
<!--                            covs.inat = covs.inat, -->
<!--                            obsc.state = obsc.state, -->
<!--                            keep.conus.grid.id = gridkey$conus.grid.id[which(gridkey$group == "train")]) -->


<!-- if (sp.code == "ANMI") { -->

<!--   # Need to replace NMGFD datasets with Bernoulli instead of occupancy -->
<!--   for (s in 1:length(species.data$obs)) { -->
<!--     nm <- constants[[paste0("name", s)]] -->
<!--     nm <- gsub(" .*", "", nm) -->

<!--     if (nm %in% c("NMGFD", "AZGFD")) { -->
<!--       constants[[paste0("nVisitsV", s)]] <- 1 -->
<!--     } -->
<!--   } -->

<!-- } -->



<!-- if (model == "proj08nostate") { -->
<!--   if (sp.code == "EBIS") { -->
<!--     data$Xw3$WV <- NULL -->
<!--     data$Xw3$VT <- NULL -->
<!--     data$S3 <- NULL -->

<!--     constants$nCovW3 <- ncol(data$Xw3) -->
<!--   } else { -->
<!--     stop("Don't know which states to remove") -->
<!--   } -->

<!--   rm.state <- T -->
<!-- } else { -->
<!--   rm.state <- F -->
<!-- } -->



<!-- ### Code ---- -->
<!-- code <- nimble_code(data, -->
<!--                     constants,  -->
<!--                     path = out.dir, -->
<!--                     sp.auto = sp.auto,  -->
<!--                     coarse.grid = coarse.grid, -->
<!--                     Bpriordist = Bpriordist, Bpriorvar1 = Bpriorvar1, Bpriorvar2 = Bpriorvar2, -->
<!--                     block.out = block.out, -->
<!--                     min.visits.incl = 3,  -->
<!--                     zero_mean = zero_mean, -->
<!--                     tau = tau, -->
<!--                     rm.state = rm.state) -->

<!-- ### Initial values ---- -->
<!-- inits <- function(x){nimble_inits(data, -->
<!--                                   constants, -->
<!--                                   sp.auto = sp.auto, -->
<!--                                   seed = x)} -->

<!-- ### Parameters ---- -->
<!-- params <- nimble_params(data, -->
<!--                         constants, -->
<!--                         lambda = T, -->
<!--                         XB = T, -->
<!--                         sp.auto = sp.auto, -->
<!--                         effort = T) -->


<!-- source("code/03-species-models/xx-flexiSDM-setuptests.R") -->


<!-- end1 <- Sys.time() - start1 -->

<!-- # Remove local and block in case the setup is run locally but the model is fit on the HPC. -->
<!-- # Remove other unnecessary files to reduce the size of setup_BLOCK.Rdata -->
<!-- rm(list=c('local','block','args','conus.covar.grid','conus.grid','usa','conus', -->
<!--           'pl','centroid')) -->


<!-- # Save environment and full set up -->
<!-- save.image(paste0(out.dir, "setup_",block.out,".Rdata")) -->


<!-- # End script - proceed to 02-flexiSDM.R -->

<!-- ## --------------------------- -->
<!-- ## Objective:  -->
<!-- ##    - Fit NIMBLE model using setup_BLOCK.rdata file -->
<!-- ##  -->
<!-- ## Input: -->
<!-- ##    - setup_BLOCK.rdata -->
<!-- ## -->
<!-- ## Output:  -->
<!-- ##    - samples_BLOCK_CHAIN.rds OR samples_BLOCK.rds -->
<!-- ## -->
<!-- ## --------------------------- -->

<!-- start2 <- Sys.time()  -->
<!-- print(paste0('Beginning 02-MVPv1.1 script at ', start2)) -->


<!-- # EDIT THIS SECTION ---- -->
<!-- num <- 1 -->
<!-- block <- "none" -->
<!-- sp.code <- "RACA" -->
<!-- model <- "WIPtest" -->
<!-- chain <- 1 -->
<!-- local <- 1 -->
<!-- # --- -->


<!-- args = commandArgs(trailingOnly = TRUE) -->

<!-- if (length(args) > 0) { -->
<!--   num = as.numeric(args[1]) -->
<!--   sp.code = as.character(args[2]) -->
<!--   model = as.character(args[3]) -->
<!--   block = as.numeric(args[4]) -->
<!--   chain = as.numeric(args[5]) -->
<!--   local = as.numeric(args[6])  -->

<!--   # If running on HPC, set working directory -->
<!--   if (local == 0) { -->
<!--     setwd('/caldera/hovenweep/projects/usgs/ecosystems/eesc/rmummah/species-futures/') -->
<!--   }  -->
<!-- } -->

<!-- # Ensure block is coded correctly -->
<!-- if (block == 4) { -->
<!--   block <- 'none' -->
<!-- } -->


<!-- # Load functions and packages -->
<!-- suppressMessages(source("functions/FXN-nimbleParallel.R")) -->
<!-- library(SpFut.flexiSDM) -->


<!-- # Set output directory and load setup file -->
<!-- out.dir = paste0('outputs/03-species-models/MVPv1/',num,'_',sp.code,'_',model,'/') -->
<!-- load(paste0(out.dir,'setup_',block,'.Rdata')) -->


<!-- # Fit NIMBLE model ---- -->
<!-- if (local == 1) { -->
<!--   start.nim <- Sys.time() -->
<!--   samples <- nimbleParallel(code = code, -->
<!--                             data = data, -->
<!--                             constants = constants, -->
<!--                             inits = inits, -->
<!--                             param = params, -->
<!--                             iter = iter, -->
<!--                             burnin = burnin, -->
<!--                             thin = thin) -->

<!--   end.nim <- Sys.time() - start.nim -->
<!--   print(end.nim) -->

<!--   saveRDS(samples, paste0(out.dir,'samples_',block,'.rds')) -->
<!-- } else { -->

<!--   info <- list(seed = chain, -->
<!--                inits = inits(chain)) -->

<!--   start.nim <- Sys.time() -->
<!--   samples <- run_nimbleMCMC(info = info,  -->
<!--                             code = code,  -->
<!--                             constants = constants,  -->
<!--                             data = data,  -->
<!--                             param = params,  -->
<!--                             iter = iter,  -->
<!--                             burnin = burnin,  -->
<!--                             thin = thin) -->

<!--   end.nim <- Sys.time() - start.nim -->
<!--   print(end.nim) -->

<!--   saveRDS(samples, paste0(out.dir,'samples_',block,'_',chain,'.rds')) -->
<!-- } -->


<!-- end2 <- Sys.time() - start2 -->
<!-- saveRDS(end2, paste0(out.dir,'time2_',block,'.rds')) -->
<!-- print(end2) -->

<!-- # End script - proceed to 03-flexiSDM.R -->

<!-- ## --------------------------- -->
<!-- ## Objective:  -->
<!-- ##    - Fit NIMBLE model using setup_BLOCK.rdata file -->
<!-- ##  -->
<!-- ## Input: -->
<!-- ##    - setup_BLOCK.rdata -->
<!-- ##    - samples_BLOCK_CHAIN.rds OR samples_BLOCK.rds -->
<!-- ## -->
<!-- ## Output:  -->
<!-- ##    - samples_BLOCK_CHAIN.rds OR samples_BLOCK.rds -->
<!-- ## -->
<!-- ## --------------------------- -->

<!-- start3 <- Sys.time() -->


<!-- ## load packages ---- -->
<!-- library(tidyverse, quietly = T) -->
<!-- library(magrittr, quietly = T) -->
<!-- library(sf, quietly = T) -->
<!-- library(SpFut.flexiSDM) -->



<!-- # EDIT THIS SECTION ---- -->
<!-- num <- 108 -->
<!-- block <- "none" -->
<!-- sp.code <- "RACA" -->
<!-- model <- "tau1" -->
<!-- maxchain <- 3 -->
<!-- local <- 1 -->
<!-- # --- -->


<!-- # Setup ---- -->
<!-- args = commandArgs(trailingOnly = TRUE) -->

<!-- if (length(args) > 0) { -->
<!--   num = as.numeric(args[1]) -->
<!--   sp.code = as.character(args[2]) -->
<!--   model = as.character(args[3]) -->
<!--   block = as.numeric(args[4]) -->
<!--   maxchain = as.numeric(args[5]) -->
<!--   local = as.numeric(args[6]) -->

<!--   if (local == 0) { -->
<!--     setwd('/caldera/hovenweep/projects/usgs/ecosystems/eesc/rmummah/species-futures/') -->
<!--   }  -->

<!-- } -->

<!-- # Ensure block is coded correctly -->
<!-- if (block == 4) { -->
<!--   block <- 'none' -->
<!-- } -->

<!-- # load output directory, setup, and functions -->
<!-- out.dir = paste0('outputs/03-species-models/MVPv1/',num,'_',sp.code,'_',model,'/') -->
<!-- load(paste0(out.dir,'setup_',block,'.Rdata')) -->




<!-- # Load chains (samples) ---- -->

<!-- if (file.exists(paste0(out.dir,'samples_',block,'.rds'))) { # If it was run locally, this file should exist -->
<!--   samples <- readRDS(paste0(out.dir,'samples_',block,'.rds')) -->
<!-- } else { -->
<!--   # Load individual sample files and save as a list -->
<!--   samples <- lapply(1:maxchain,  -->
<!--                     FUN = function(x) { -->
<!--                       readRDS(paste0(out.dir,'samples_',block,'_',x,'.rds')) -->
<!--                     }) -->
<!-- } -->



<!-- ## Calculate derived quantities ---- -->
<!-- # This takes longer with the coarse grid. -->
<!-- samples <- lapply(samples, get_derived, data = data, project = project,  -->
<!--                   coarse.grid = coarse.grid, spatRegion = spatRegion, -->
<!--                   pathToProj = 'code/03-species-models/setup-projections.R') -->


<!-- # Plot chains before summarizing -->
<!-- cov.labs <- read.csv("data/covariate-labels.csv") -->

<!-- ### Chains ---- -->
<!-- ggsave(plot_chains(samples, data = data, cov.labs = cov.labs, plot = "B", cutoff = 0), file = paste0(out.dir, "3_parameters-a1_chains-B-",block,".jpg"), height = 6, width = 8) -->
<!-- ggsave(plot_chains(samples, data = data, cov.labs = cov.labs, plot = "alpha", cutoff = 0), file = paste0(out.dir, "3_parameters-b1_chains-alpha-",block,".jpg"), height = 6, width = 8) -->
<!-- ggsave(plot_chains(samples, data = data, cov.labs = cov.labs, plot = "tau", cutoff = 0), file = paste0(out.dir, "3_parameters-b1_chains-tau-",block,".jpg"), height = 6, width = 8) -->

<!-- # Posteriors ---- -->
<!-- ggsave(plot_posteriors(samples, data = data, cov.labs = cov.labs, plot = "B", cutoff = 0), file = paste0(out.dir, "3_parameters-a2_posteriors-B.jpg"), height = 6, width = 8) -->
<!-- ggsave(plot_posteriors(samples, data = data, cov.labs = cov.labs, plot = "alpha", cutoff = 0), file = paste0(out.dir, "3_parameters-b2_posteriors-alpha.jpg"), height = 6, width = 8) -->


<!-- ## Summarize chains ---- -->
<!-- out <- summarize_samples(samples,  -->
<!--                          data,  -->
<!--                          constants,  -->
<!--                          project = project, -->
<!--                          coarse.grid = coarse.grid, -->
<!--                          block.out = block.out, -->
<!--                          gridkey = gridkey,  -->
<!--                          spatkey = spatRegion$spatkey, -->
<!--                          effort = T, -->
<!--                          SLURM = ifelse(local == 1, F, T)) -->

<!-- save(out, file = paste0(out.dir, "data", blockname, ".rdata")) -->



<!-- # Plot output ---- -->

<!-- # Convergence -->
<!-- ggsave(plot_convergence(out), file = paste0(out.dir, "3_parameters-0_convergence-", block, ".jpg"), -->
<!--        height = 5, width = 12) -->

<!-- if (block.out == "none") { -->

<!--   ### Parameter estimates ---- -->
<!--   ggsave(plot_pars(out,  -->
<!--                    plot.type = "full",  -->
<!--                    plot.group = "process",  -->
<!--                    title = "Process parameter estimates", -->
<!--                    cov.labs = cov.labs), -->
<!--          file = paste0(out.dir, "3_parameters-a3_B.jpg"), height = 6, width = 10) -->

<!--   ggsave(plot_pars(out,  -->
<!--                    plot.type = "full",  -->
<!--                    plot.group = "observation",  -->
<!--                    title = "Observation parameter estimates", -->
<!--                    cov.labs = cov.labs), -->
<!--          file = paste0(out.dir, "3_parameters-b3_alpha.jpg"), height = 6, width = 10) -->

<!--   ggsave(plot_pars(out,  -->
<!--                    plot.type = "full",  -->
<!--                    plot.group = "dataset",  -->
<!--                    title = "Dataset intercept estimates"), -->
<!--          file = paste0(out.dir, "3_parameters-c3_observation.jpg"), height = 6, width = 10) -->

<!--   ggsave(plot_pars(out,  -->
<!--                    plot.type = "full",  -->
<!--                    plot.group = "tau",  -->
<!--                    title = "Tau estimate"), -->
<!--          file = paste0(out.dir, "3_parameters-c3_tau.jpg"), height = 6, width = 10) -->

<!--   ### Marginal effects ---- -->
<!--   ggsave(plot_effects(data, out, breaks = 0.001), file = paste0(out.dir, "/3_parameters-a4-effects.jpg"), height = 7, width = 10) -->




<!--   ### Plot effort and PO records ---- -->

<!--   tmp <- full_join(select(out$effort, conus.grid.id, PO.dataset.name, mean), select(out$lambda0, conus.grid.id, mean), by = "conus.grid.id") %>% -->
<!--     rename(mean.effort = mean.x, -->
<!--            mean.lambda = mean.y) -->

<!--   ind <- grep("nW", names(constants)) -->
<!--   nums <- gsub("nW", "", names(constants)[ind]) -->

<!--   dat <- c() -->
<!--   for (i in 1:length(nums)) { -->
<!--     dat1 <- data.frame(W = data[[paste0("W", nums[i])]], -->
<!--                        grid.id = constants[[paste0("Wcells", nums[i])]], -->
<!--                        PO.dataset.name = constants[[paste0("name", nums[i])]]) -->

<!--     dat <- bind_rows(dat, dat1) -->
<!--   } -->
<!--   dat <- dat %>% -->
<!--     full_join(gridkey, by = "grid.id") -->

<!--   tmp1 <- full_join(tmp, dat, by = c("conus.grid.id", "PO.dataset.name")) %>% -->
<!--     mutate(recpereff = W / mean.effort, -->
<!--            adjlambda = mean.effort * mean.lambda) -->

<!--   pl <- ggplot(tmp1) + -->
<!--     geom_point(aes(x = recpereff, y = mean.lambda), alpha = 0.5) + -->
<!--     geom_smooth(aes(x = recpereff, y = mean.lambda), method = "lm") + -->
<!--     facet_wrap(~ PO.dataset.name, scales = "free") + -->
<!--     theme_bw() + -->
<!--     labs(x = "Number of records per unit of effort", y = "Estimated lambda") -->
<!--   ggsave(pl, file = paste0(out.dir, "/X_recordspereffort.jpg"), height = 8, width = 8) -->

<!--   pl <- ggplot(tmp1) + -->
<!--     geom_point(aes(x = mean.effort, y = W), alpha = 0.5) + -->
<!--     geom_smooth(aes(x = mean.effort, y = W), method = "lm") + -->
<!--     facet_wrap(~ PO.dataset.name, scales = "free") + -->
<!--     theme_bw() + -->
<!--     labs(x = "Estimated effort", y = "Number of records") -->
<!--   ggsave(pl, file = paste0(out.dir, "/X_recordsvseffort.jpg"), height = 8, width = 8) -->


<!--   ### Maps ---- -->
<!--   # Current -->
<!--   pl <- map_species_data(title = paste0(common, " (", sp.code, ")"),  -->
<!--                          region,  -->
<!--                          plot = "lambda", -->
<!--                          out = out) -->
<!--   ggsave(pl, file = paste0(out.dir, "4_mapcurrent-a_lambda.jpg"), height = 7, width = 9) -->

<!--   pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                          region,  -->
<!--                          plot = "lambda", -->
<!--                          out = out,  -->
<!--                          plot.uncertainty = "unc.range") -->
<!--   ggsave(pl, file = paste0(out.dir, "4_mapcurrent-a_lambda-uncabs.jpg"), height = 7, width = 9) -->

<!--   pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                          region, -->
<!--                          plot = "lambda", -->
<!--                          out = out,  -->
<!--                          plot.uncertainty = "unc.rel") -->
<!--   ggsave(pl, file = paste0(out.dir, "4_mapcurrent-a_lambda-uncrel.jpg"), height = 7, width = 9) -->

<!--   pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                          region, -->
<!--                          plot = "psi", -->
<!--                          out = out) -->
<!--   ggsave(pl, file = paste0(out.dir, "4_mapcurrent-b_psi.jpg"), height = 7, width = 9) -->

<!--   pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                          region, -->
<!--                          plot = "psi", -->
<!--                          out = out,  -->
<!--                          plot.uncertainty = "unc.range") -->
<!--   ggsave(pl, file = paste0(out.dir, "4_mapcurrent-b_psi-uncabs.jpg"), height = 7, width = 9) -->

<!--   pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                          region, -->
<!--                          plot = "psi", -->
<!--                          out = out,  -->
<!--                          plot.uncertainty = "unc.rel") -->
<!--   ggsave(pl, file = paste0(out.dir, "4_mapcurrent-b_psi-uncrel.jpg"), height = 7, width = 9) -->

<!--   pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                          region, -->
<!--                          plot = "boundary", -->
<!--                          out = out,  -->
<!--                          threshold = 0.25) -->
<!--   ggsave(pl, file = paste0(out.dir, "4_mapcurrent-c1_boundary-0.25.jpg"), height = 7, width = 9) -->

<!--   pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                          region, -->
<!--                          plot = "boundary", -->
<!--                          out = out,  -->
<!--                          threshold = 0.5) -->
<!--   ggsave(pl, file = paste0(out.dir, "4_mapcurrent-c2_boundary-0.5.jpg"), height = 7, width = 9) -->

<!--   pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                          region, -->
<!--                          plot = "boundary", -->
<!--                          out = out,  -->
<!--                          threshold = 0.75) -->
<!--   ggsave(pl, file = paste0(out.dir, "4_mapcurrent-c3_boundary-0.75.jpg"), height = 7, width = 9) -->

<!--   if (sp.auto == T) { -->
<!--     pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                            region, -->
<!--                            plot = "spat", -->
<!--                            out = out, -->
<!--                            coarse.grid = coarse.grid, -->
<!--                            spatRegion = spatRegion) -->
<!--     ggsave(pl, file = paste0(out.dir, "4_mapcurrent-d_spat.jpg"), height = 7, width = 9) -->
<!--   } -->

<!--   pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                          region, -->
<!--                          plot = "XB", -->
<!--                          out = out, -->
<!--                          plot.exp = T) -->
<!--   ggsave(pl, file = paste0(out.dir, "4_mapcurrent-d_expXB.jpg"), height = 7, width = 9) -->


<!--   pl <- map_species_data(title = paste0(common, " (", sp.code, ")"),  -->
<!--                          region,  -->
<!--                          plot = "effort", -->
<!--                          out = out) -->
<!--   ggsave(pl, file = paste0(out.dir, "4_mapcurrent-e_effort.jpg"), height = 7, width = 9) -->

<!--   ### Future projections ---- -->
<!--   if (project > 0) { -->
<!--     pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                            region, -->
<!--                            plot = "lambda", -->
<!--                            out = out,  -->
<!--                            plot.current = F,  -->
<!--                            plot.change = F, -->
<!--                            proj.names = proj.names) -->
<!--     ggsave(pl, file = paste0(out.dir, "5_mapfuture-a_lambda.jpg"), height = 7, width = 9) -->

<!--     pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                            region, -->
<!--                            plot = "lambda", -->
<!--                            out = out,  -->
<!--                            plot.current = F,  -->
<!--                            plot.change = F,  -->
<!--                            plot.uncertainty = "unc.range", -->
<!--                            proj.names = proj.names) -->
<!--     ggsave(pl, file = paste0(out.dir, "5_mapfuture-a_lambda-uncabs.jpg"), height = 7, width = 9) -->

<!--     pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                            region, -->
<!--                            plot = "lambda", -->
<!--                            out = out,  -->
<!--                            plot.current = F,  -->
<!--                            plot.change = F,  -->
<!--                            plot.uncertainty = "unc.rel", -->
<!--                            proj.names = proj.names) -->
<!--     ggsave(pl, file = paste0(out.dir, "5_mapfuture-a_lambda-uncrel.jpg"), height = 7, width = 9) -->

<!--     pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                            region,  -->
<!--                            plot = "psi", -->
<!--                            out = out,  -->
<!--                            plot.current = F,  -->
<!--                            plot.change = F, -->
<!--                            proj.names = proj.names) -->
<!--     ggsave(pl, file = paste0(out.dir, "5_mapfuture-b_psi.jpg"), height = 7, width = 9) -->

<!--     pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                            region, -->
<!--                            plot = "psi", -->
<!--                            out = out,  -->
<!--                            plot.current = F,  -->
<!--                            plot.change = F,  -->
<!--                            plot.uncertainty = "unc.range", -->
<!--                            proj.names = proj.names) -->
<!--     ggsave(pl, file = paste0(out.dir, "5_mapfuture-b_psi-uncabs.jpg"), height = 7, width = 9) -->

<!--     pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                            region, -->
<!--                            plot = "psi", -->
<!--                            out = out,  -->
<!--                            plot.current = F,  -->
<!--                            plot.change = F,  -->
<!--                            plot.uncertainty = "unc.rel", -->
<!--                            proj.names = proj.names) -->
<!--     ggsave(pl, file = paste0(out.dir, "5_mapfuture-b_psi-uncrel.jpg"), height = 7, width = 9) -->

<!--     pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                            region, -->
<!--                            plot = "boundary", -->
<!--                            out = out,  -->
<!--                            plot.current = F,  -->
<!--                            plot.change = F,  -->
<!--                            threshold = 0.25, -->
<!--                            proj.names = proj.names) -->
<!--     ggsave(pl, file = paste0(out.dir, "5_mapfuture-c1_boundary-0.25.jpg"), height = 7, width = 9) -->

<!--     pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                            region, -->
<!--                            plot = "boundary", -->
<!--                            out = out,  -->
<!--                            plot.current = F,  -->
<!--                            plot.change = F,  -->
<!--                            threshold = 0.5, -->
<!--                            proj.names = proj.names) -->
<!--     ggsave(pl, file = paste0(out.dir, "5_mapfuture-c2_boundary-0.5.jpg"), height = 7, width = 9) -->

<!--     pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                            region, -->
<!--                            plot = "boundary", -->
<!--                            out = out,  -->
<!--                            plot.current = F,  -->
<!--                            plot.change = F,  -->
<!--                            threshold = 0.75, -->
<!--                            proj.names = proj.names) -->
<!--     ggsave(pl, file = paste0(out.dir, "5_mapfuture-c3_boundary-0.75.jpg"), height = 7, width = 9) -->

<!--     pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                            region, -->
<!--                            plot = "XB", -->
<!--                            out = out,  -->
<!--                            plot.exp = T, -->
<!--                            plot.current = F, -->
<!--                            proj.names = proj.names) -->
<!--     ggsave(pl, file = paste0(out.dir, "5_mapfuture-d_expXB-future.jpg"), height = 7, width = 9) -->


<!--     ### Future absolute change ---- -->
<!--     pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                            region, -->
<!--                            plot = "lambda", -->
<!--                            out = out,  -->
<!--                            plot.current = F,  -->
<!--                            plot.change = "absolute", -->
<!--                            proj.names = proj.names) -->
<!--     ggsave(pl, file = paste0(out.dir, "6_mapchange-a1_lambda-abs.jpg"), height = 7, width = 9) -->

<!--     pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                            region, -->
<!--                            plot = "psi", -->
<!--                            out = out,  -->
<!--                            plot.current = F,  -->
<!--                            plot.change = "absolute", -->
<!--                            proj.names = proj.names) -->
<!--     ggsave(pl, file = paste0(out.dir, "6_mapchange-b1_psi-abs.jpg"), height = 7, width = 9) -->

<!--     pl <- map_species_data(title = paste0(common, " (", sp.code, ")"),  -->
<!--                            region, -->
<!--                            plot = "boundary", -->
<!--                            out = out,  -->
<!--                            plot.current = F,  -->
<!--                            plot.change = "absolute",  -->
<!--                            threshold = 0.25, -->
<!--                            proj.names = proj.names) -->
<!--     ggsave(pl, file = paste0(out.dir, "6_mapchange-c1_boundary-abs-0.25.jpg"), height = 7, width = 9) -->

<!--     pl <- map_species_data(title = paste0(common, " (", sp.code, ")"),  -->
<!--                            region, -->
<!--                            plot = "boundary", -->
<!--                            out = out,  -->
<!--                            plot.current = F,  -->
<!--                            plot.change = "absolute",  -->
<!--                            threshold = 0.5, -->
<!--                            proj.names = proj.names) -->
<!--     ggsave(pl, file = paste0(out.dir, "6_mapchange-c2_boundary-abs-0.5.jpg"), height = 7, width = 9) -->

<!--     pl <- map_species_data(title = paste0(common, " (", sp.code, ")"),  -->
<!--                            region, -->
<!--                            plot = "boundary", -->
<!--                            out = out,  -->
<!--                            plot.current = F,  -->
<!--                            plot.change = "absolute",  -->
<!--                            threshold = 0.75, -->
<!--                            proj.names = proj.names) -->
<!--     ggsave(pl, file = paste0(out.dir, "6_mapchange-c3_boundary-abs-0.75.jpg"), height = 7, width = 9) -->

<!--     ### Future relative change ---- -->
<!--     pl <- map_species_data(title = paste0(common, " (", sp.code, ")"),  -->
<!--                            region, -->
<!--                            plot = "lambda", -->
<!--                            out = out,  -->
<!--                            plot.current = F,  -->
<!--                            plot.change = "relative", -->
<!--                            proj.names = proj.names) -->
<!--     ggsave(pl, file = paste0(out.dir, "6_mapchange-a2_lambda-rel.jpg"), height = 7, width = 9) -->

<!--     pl <- map_species_data(title = paste0(common, " (", sp.code, ")"),  -->
<!--                            region, -->
<!--                            plot = "psi",  -->
<!--                            out = out,  -->
<!--                            plot.current = F, -->
<!--                            plot.change = "relative", -->
<!--                            proj.names = proj.names) -->
<!--     ggsave(pl, file = paste0(out.dir, "6_mapchange-b2_psi-rel.jpg"), height = 7, width = 9) -->
<!--   } -->
<!-- } -->





<!-- # Validate ---- -->

<!-- # Get all data -->
<!-- species.data <- load_species_data(sp.code, -->
<!--                                   sp.code.all, -->
<!--                                   file.name = allfiles$file, -->
<!--                                   file.label = allfiles$name, -->
<!--                                   file.path = "DATA SWAMP/data-ready/", -->
<!--                                   keep.cols = covariates, -->
<!--                                   region = region,  -->
<!--                                   filter.region = filter.region, -->
<!--                                   year.start = year.start, -->
<!--                                   year.end = year.end, -->
<!--                                   coordunc = coordunc, -->
<!--                                   coordunc_na.rm = coordunc_na.rm, -->
<!--                                   spat.thin = spat.bal, -->
<!--                                   keep.conus.grid.id = gridkey$conus.grid.id) -->



<!-- all.auc <- get_AUC(species.data, out) -->



<!-- # Save everything ---- -->
<!-- if (block.out == "none") { -->
<!--   blockname <- "full" -->
<!--   save(region, file = paste0(out.dir, "region.rdata")) -->
<!-- } else {blockname <- block.out} -->

<!-- save(species.data, covar, covar_unscaled, data, constants, gridkey, all.auc, block.out, -->
<!--      file = paste0(out.dir, "data", blockname, "-info.rdata")) -->


<!-- # Final CV Figures ---- -->
<!-- # Make final cross validation figs if all blocks have been done -->

<!-- done <- list.files(path = out.dir) -->

<!-- mod.name <- c('data1','data2','data3','datafull') -->


<!-- if (all(c(paste0(mod.name, '.rdata'), paste0(mod.name, '-info.rdata')) %in% done)) { -->

<!--   # Load data from all model runs -->
<!--   auc <- c() -->
<!--   proc <- c() -->
<!--   obs <- c() -->
<!--   alpha <- c() -->
<!--   for (i in 1:3) { -->
<!--     load(paste0(out.dir, "data", i, "-info.rdata")) -->
<!--     load(paste0(out.dir, "data", i, ".rdata")) -->

<!--     # If validation data is missing, skip -->
<!--     if (length(all.auc) == 1) next -->

<!--     out$process.coef$block.out <- as.character(out$process.coef$block.out) -->
<!--     out$obs.coef$block.out <- as.character(out$obs.coef$block.out) -->
<!--     out$alpha$block.out <- as.character(out$alpha$block.out) -->

<!--     auc <- bind_rows(auc, all.auc) -->
<!--     proc <- bind_rows(proc, out$process.coef) -->
<!--     obs <- bind_rows(obs, out$obs.coef) -->
<!--     alpha <- bind_rows(alpha, out$alpha) -->

<!--   } -->

<!--   # If validation data exists... -->
<!--   if (!is.null(auc)) { -->

<!--     # now add full model -->
<!--     load(paste0(out.dir, "datafull.rdata")) -->

<!--     out$process.coef$block.out <- as.character(out$process.coef$block.out) -->
<!--     out$obs.coef$block.out <- as.character(out$obs.coef$block.out) -->
<!--     out$alpha$block.out <- as.character(out$alpha$block.out) -->

<!--     proc <- bind_rows(proc, out$process.coef) -->
<!--     obs <- bind_rows(obs, out$obs.coef) -->
<!--     alpha <- bind_rows(alpha, out$alpha) -->


<!--     load(paste0(out.dir, "datafull-info.rdata")) -->
<!--     auc$block <- as.character(auc$block) -->
<!--     auc <- bind_rows(auc, all.auc) -->


<!--     ggsave(plot_pars(out = proc,  -->
<!--                      plot.type = "cv",  -->
<!--                      plot.group = "process",  -->
<!--                      title = "Process parameter estimates", -->
<!--                      cov.labs = cov.labs), -->
<!--            file = paste0(out.dir, "7_CV-a-parameters-process.jpg"), height = 6, width = 10) -->

<!--     ggsave(plot_pars(out = alpha,  -->
<!--                      plot.type = "cv",  -->
<!--                      plot.group = "dataset",  -->
<!--                      title = "Dataset parameter estimates", -->
<!--                      cov.labs = cov.labs), -->
<!--            file = paste0(out.dir, "7_CV-b-parameters-dataset.jpg"), height = 6, width = 10) -->

<!--     ggsave(plot_pars(out = obs,  -->
<!--                      plot.type = "cv",  -->
<!--                      plot.group = "observation",  -->
<!--                      title = "Observation parameter estimates", -->
<!--                      cov.labs = cov.labs), -->
<!--            file = paste0(out.dir, "7_CV-a-parameters-observation.jpg"), height = 6, width = 10) -->


<!--     # Plot AUC -->
<!--     ggsave(plot_auc(auc, lines = T), file = paste0(out.dir, "7_CV-d_AUClines.jpg"), height = 7, width = 10) -->
<!--     ggsave(plot_auc(auc, lines = F), file = paste0(out.dir, "7_CV-d_AUCnolines.jpg"), height = 7, width = 10) -->
<!--   } -->
<!-- } -->


<!-- # Create time-summary output file ---- -->
<!-- cat("Summarization and visualization complete \n\n") -->

<!-- end3 <- Sys.time() - start3 -->

<!-- # Start output file -->
<!-- sink(paste0(out.dir,'time-summary_',block,'.txt')) -->

<!-- cat(paste0("Time summary for: ", nums.do,' ',sp.code,' ',model,'\n\n')) -->

<!-- cat(paste0('The model was run on ', format(Sys.time(), "%a %b %Y %d %X"),'\n\n')) -->


<!-- # Print total time to output file -->
<!-- cat('Total time for setup:\n') -->
<!-- print(end1) -->
<!-- cat('\n') -->

<!-- end2 <- readRDS(paste0(out.dir, 'time2_',block,'.rds')) -->
<!-- cat('Total time for fitting NIMBLE model: \n') -->
<!-- print(end2) -->
<!-- cat('\n') -->

<!-- cat('Total time for summarization: \n') -->
<!-- print(end3) -->
<!-- cat('\n') -->

<!-- cat('Start to finish time (code): \n') -->
<!-- print(end1 + end2 + end3) -->
<!-- cat('\n') -->

<!-- cat('Start to finish time (user delay): \n') -->
<!-- print(Sys.time() - start1) -->
<!-- cat('\n\n') -->

<!-- # Close output file -->
<!-- sink() -->

<!-- cat("Removing intermediate files...\n") -->
<!-- # system(paste0("rm ./outputs/03-species-models/MVPv1/",number,'_',sp.code,'_',model,"/setup_",block,"*")) -->
<!-- # system(paste0("rm ./outputs/03-species-models/MVPv1/",number,'_',sp.code,'_',model,"/samples_",block,"*")) -->
<!-- # system(paste0("rm ./outputs/03-species-models/MVPv1/",number,'_',sp.code,'_',model,"/time2_",block,".rds")) -->

<!-- cat(paste0("Model ",number,' ',sp.code,' ',model," complete!!\n")) -->


<!-- # End script -->


