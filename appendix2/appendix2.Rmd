---
title: "Appendix 2"
output: pdf_document
date: "Last updated: `r Sys.Date()`"
toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, messages = FALSE, warning = FALSE, cache = TRUE)
```

<!-- ## --------------------------- -->
<!-- ## Objective: -->
<!-- ##    - Imports species and covariate data -->
<!-- ##    - Scales covariates -->
<!-- ##    - Sets up data for NIMBLE -->
<!-- ## -->
<!-- ## Input: -->
<!-- ##    - functions/FXN-MVPv1.1.R -->
<!-- ##    - code/03-species-models/MVPv1.csv -->
<!-- ## -->
<!-- ## Output: -->
<!-- ##    - setup_BLOCK.rdata (saves environment for import to fit model) -->
<!-- ## -->
<!-- ## --------------------------- -->

So you wanna fit an integrated species distribution model? You've come to the right place!

# NEED SOME SORT OF INTRO HERE.

- The first part of this sets up the range, imports species and covariate data, scales covariates, and sets everything up for NIMBLE.
- The second part fits the NIMBLE model
- The third part summarizes the NIMBLE output and creates output figures.


Let's first load the libraries we'll need to set up, visualize, fit, and summarize our data.

```{r libraries, results = 'hide'}
# Load libraries ----
library(tidyverse)
library(sf)
library(nimble)

## To install SpFut.flexiSDM or check for updates, use the commented code below:
# remotes::install_github("rileymummah/SpFut.flexiSDM", build_vignettes = T)
library(SpFut.flexiSDM)
library(SpFut.covariates)
```


## Model specifications

To load data or fit a model, you must first create a .csv file that outlines the model specifications. We call ours `model-specs.csv`. Let's load the .csv and take a look at how we structured it.

```{r model-specs}
mods <- read.csv("code/model-specs.csv")

head(mods, n=2)
```

The following table describes the column names, data type, and description found in `model-specs.csv`. Not all columns are required depending how you intend to fit the model (i.e., local computer vs. high performance computing cluster).

| Column Name     | Type      | Description                              |
|-----------------|-----------|------------------------------------------|
| number          | numeric   | Model number                             |
| sp.code         | character | Four digit species code                  |
| model           | character | Model name                               |
| mem.nim         | numeric   | Memory allocation (in MB) for NIMBLE. Could be omitted if not using an HPC. |
| mem.sum         | numeric   | Memory allocation (in MB) for parallelized summarization. Could be omitted if not using an HPC. |
| year.start      | numeric   | Starting year of data inclusion          |
| year.end        | numeric   | Ending year of data inclusion            |
| buffer          | numeric   | Size of buffer around range edge (in km) |
| sp.auto         | logical   | Should a spatial model be included?      |
| zero_mean       | logical   | Should a zero mean assumption be included in the spatial model? |
| tau             | numeric/character | Assign a fixed value or a prior distribution in BUGS language for precision ($\tau$; e.g., dgamma(5,5)) |
| coarse.grid     | logical   | Should a coarse grid be used for the spatial model? Usually desired for large-range species |
| cont.grid       | logical   | Should the grid be restricted to continuous cells? (This will remove any groups of non-contiguous cells) |
| covs.PO         | character | A comma-separated list of covariates for modeling PO sampling effort. These must match the covariate names in the data. |
| covs.inat       | character | A comma-separated list of covariates for modeling iNaturalist sampling effort. These must match the covariate names in the data. |
| covs.lin        | character | A comma-separated list of linear covariates for modeling species relative abundance. These must match the covariate names in the data. |
| covs.quad       | character | A comma-separated list of quadratic covariates for modeling species relative abundance. These must match the covariate names in the data. |
| check.covs      | logical   | Should covariate selection remove multicollinearity? |
| Bprior          | character | Assign a prior distribution in BUGS lanaguage for the $\beta$ coefficients in the state model (e.g., dnorm(1,0))
| filter.region   | logical   | Should the region be spatially filtered?          |
| spat.bal        | logical   | Should the PO data be spatially balanced?         |
| coordunc        | numeric   | The level of acceptable coordinate uncertainty    |
| coordunc_na.rm  | logical   | Should coordinates with uncertainty beyond `coordunc` be removed? |
| block.rows      | numeric   | The number of rows for cross-validation blocks    |
| block.cols      | numeric   | The number of columns for cross-validation blocks |
| block.folds     | numeric   | The number of cross-validation block groups       |
| iter            | numeric   | The number of iterations to run an MCMC chain     |
| thin            | numeric   | Thin the MCMC chains by this parameter            |
| region.sub      | logical   | Only use the centroid of the region with a radius equal to the buffer size? |
| lon.hi          | numeric   | High longitude value to restrict the range
| lon.lo          | numeric   | Low longitude value to restrict the range
| lat.hi          | numeric   | High latitude value to restrict the range
| lat.lo          | numeric   | Low latitude value to restrict the range
| project         | numeric   | The number of future projections (otherwise, NA)  |
| exclude.dataset | character | A comma-separated list of datasets to exclude from analysis |


We have set up the scripts in the flexiSDM workflow so that a minimum number of parameters needs to be changed among them. To run this script in full (using our file arrangement), you only need to edit the following parameters:

```{r param.edit}
nums.do <- 3 # model number to run
block <- 'none' # block to run ('none', 1, 2, or 3)
local <- 1 # are you running the code locally (1) or on an HPC (0)?
```

For the purposes of this demonstration, we're going to fit a model to the centroid of the Cascades frog (RACA) range with a 50,000km buffer. This will allow us to easily visualize the datasets and spatial grid, while maintaining local computational capabilities. 



### Load model specifications

Now that we have loaded our model specifications, we can use them to define a series of inputs for the setup script (found in `01-flexiSDM.R`).

```{r mods}
## Set up model variables
mods <- filter(mods, number %in% nums.do)

## Get variables for model from model-specs.csv
number <- mods$number[1] # model number
sp.code <- mods$sp.code[1] # 4-digit species code
model <- mods$model[1] # model name
sp.auto <- mods$sp.auto[1] # include spatial autocorrelation?
coarse.grid <- mods$coarse.grid[1] # use a coarse grid?
cont.grid <- mods$cont.grid[1] # restrict to only a continuous grid?
year.start <- mods$year.start[1] # start year for data
year.end <- mods$year.end[1] # end year for data
buffer <- mods$buffer[1] # buffer size (km)
filter.region <- mods$filter.region[1] # filter the region? LANE - FILTER BY WHAT?
spat.bal <- mods$spat.bal[1] # include spatial balancing?
coordunc <- mods$coordunc[1] # level of coordinate uncertainty to include (km)
coordunc_na.rm <- mods$coordunc_na.rm[1] # filter by coordinate uncertainty?
block.folds <- mods$block.folds[1] # how many groups of blocks?
block.rows <- mods$block.rows[1] # how many rows of blocks?
block.cols <- mods$block.cols[1] # how many columns of blocks?
block.out <- block # define the block to setup

if (block.out == "none") {
  blockname <- "full" # rename the block to 'full' if not doing cross-validation
} else {blockname <- block.out} # otherwise, keep the block number

# names of datasets to exclude (e.g., iNaturalist) - must match dataset naming
exclude.dataset <- unlist(str_split(mods$exclude.dataset[1], pattern = ", "))

## ICAR parameters
zero_mean <- mods$zero_mean[1] # zero mean assumption?
tau <- mods$tau[1] # precision (tau) can be a fixed value or a prior

## MCMC parameters
iter <- mods$iter[1] # number of MCMC iterations
thin <- mods$thin[1] # number to thin by
burnin <- floor(iter*0.75) # burnin to discard

## Change of region
region.sub <- mods$region.sub[1] # only estimate for a subregion?
lat.hi <- mods$lat.hi[1] # high value of latitude range
lat.lo <- mods$lat.lo[1] # low value of latitude range
lon.hi <- mods$lon.hi[1] # high value of longitude range
lon.lo <- mods$lon.lo[1] # low value of longitude range

## Future projections
project <- mods$project[1] # how many projections?
if (block.out != "none") {
  project <- 0 # no projections for cross-validation blocks
}

## Covariates
# list of PO covariates
covs.PO <- unlist(str_split(mods$covs.PO[1], pattern = ", "))
# list of iNaturalist covariates
covs.inat <- unlist(str_split(mods$covs.inat[1], pattern = ", "))
# list of linear covariates for state model
covs.lin <- unlist(str_split(mods$covs.lin[1], pattern = ", "))
# list of quadratic covariates for state model
covs.quad <- unlist(str_split(mods$covs.quad[1], pattern = ", "))
check.covs <- mods$check.covs[1] # covariate selection to remove multicollinearity?

## Define the prior for the state model coefficients
Bprior <- mods$Bprior[1]

## Combine linear and quadratic distribution covariates into covs.z
covs.z <- c(covs.lin, covs.quad)
if ("" %in% covs.z) {
  covs.z <- covs.z[-which(covs.z == "")]  
}
if (NA %in% covs.z) {
  covs.z <- covs.z[-which(is.na(covs.z))]
}
```


Now we're ready to set up the region and load data and covariates. First, let's ensure that we have output and data folders specific to the model we are fitting.

```{r output-folder}
## Make output folder
out.dir <- paste0("outputs/", number, "_", sp.code, "_", model, "/")
if (dir.exists(out.dir) == F) {
  dir.create(out.dir)
}

## Make data folder
data.dir <- paste0("data/", number, "_", sp.code, "_", model, "/")
if (dir.exists(data.dir) == F) {
  dir.create(data.dir)
}
```




## Step 1: Define the region

We define the region of inference using the GAP and IUCN ranges. Other boundaries could be used to create the limits of the range. We saved the IUCN and GAP range boundaries in folders in `data/sp.code`, so that they can be called by the `get_range` function. We have also downloaded the US Census state boundary shapefile (`cb_2018_us_state_500k.shp`) to dictate the national and state borders. We have already overlaid a continental US hexbin grid and associated covariates to grid cells (`grid-covar`). Unfortunately, this file is too large to upload to GitHub, so we demonstrate how we create the region and provide the file in `data.dir/region.rds` to bypass this step.

```{r ranges, results = 'hide'}
## Generating the region requires files that are too big for GitHub just read it in
if (file.exists(paste0(data.dir, "region.rds"))) {
  region <- read_rds(file = paste0(data.dir, "region.rds"))
} else {
  ## Load ranges
  range.path <- c(paste0("data/", sp.code, "/GAP/"),
                  paste0("data/", sp.code, "/IUCN/"))
  range.name <- c("GAP", "IUCN")
  rangelist <- get_range(range.path,
                         range.name,
                         crs = 4326)
  ## USA boundary
  exclude <- c("Alaska", "Hawaii", "Commonwealth of the Northern Mariana Islands",
               "American Samoa", "United States Virgin Islands", "Guam", "Puerto Rico")
  usa <- st_read("../species-futures/data/USA/maps/cb_2018_us_state_500k/cb_2018_us_state_500k.shp") %>%
          filter((NAME %in% exclude) == F) %>%
          st_union()
  ## CONUS grid
  load("../species-futures/data/USA/grid-covar.rdata") # Too big for GitHub

  ## Region
  region <- make_region(rangelist,
                        buffer = buffer,
                        crs = 3857,
                        sub = region.sub,
                        boundary = usa,
                        grid = conus.grid,
                        rm.clumps = T,
                        clump.size = 50)
  
  write_rds(region, file = paste0(data.dir, "region.rds"))
}
```

There is one additional step here if you intend to use the coarse spatial grid. We must redefine the spatial grid by grouping hexbins together in sets of seven via the `make_spatkey` function. Otherwise, `spatRegion` is set to NULL.

```{r spatRegion}
## If using the coarse spatial grid, redefine the grid and plot the resulting grid.
if (coarse.grid == T) {
  spatRegion <- suppressWarnings(make_spatkey(region$sp.grid))

  # Print spatial grid
  if (block.out == 'none') {
    pl <- ggplot(spatRegion$spat.grid) + geom_sf() + theme_bw()
    ggsave(pl, file = paste0(out.dir, "2_inputmap-e_spatGrid.jpg"), height = 8, width = 10)
  }
} else {
  spatRegion <- NULL
}
```



## Step 2: Set up cross-validation blocks

We have set up the code so that this section needs to be run even if you do not intend to use cross-validation blocks. If you do not desire, cross-validation blocks, all of the data are considered "training data". Otherwise, the data are split into "test" and "training" data depending on the cross-validation fold (1, 2, or 3) that is selected to run.

```{r cv-blocks}
## Set up cross validation blocks
spatblocks <- make_CV_blocks(region, rows = block.rows, cols = block.cols, k = block.folds)

## Set up training and test sets based on cross validation blocks
if (block.out == "none") { # If fitting the full model, then there are
  test.i <- c()            # no test data
  train.i <- region$sp.grid$conus.grid.id

} else {
  block1 <- spatblocks %>% filter(folds == block.out)

  ## Find grid.ids for test block, everything else is in the training block
  test.i <- st_intersection(region$sp.grid, block1) %>%
             pull(conus.grid.id) %>%
             unique()
  train.i <- filter(region$sp.grid, conus.grid.id %in% test.i == F) %>%
              pull(conus.grid.id)
}
```


After the cross-validation blocks are assembled and the data are assigned to "training" and "test" sets, we make a `gridkey` that allows us to index the data in NIMBLE by assigning the data to one of two groups.
MOVE THIS TO NIMBLE CODE AREA?

```{r gridkey}
# Make gridkey ----
gridkey <- select(region$sp.grid, conus.grid.id) %>%
  st_drop_geometry() %>%
  mutate(group = case_when(conus.grid.id %in% train.i ~ "train",
                           conus.grid.id %in% test.i ~ "test"))
```




## Step 3: Load species data

We're now ready to load the species data. We have assembled a full amphibian species list (`model-specieslist.csv`) from which we pull out the common name, any species code that could refer to the species of interest, and the scientific name. We demonstrate how we did this process, but these values could be set manually or pulled from a list. We additionally define the species type (e.g., Frog/Toad or Salamander) based off the genus name. This delineation is used later for covariate data.

```{r spp-codes}
## Define species codes
codeKey <- read.csv("data/model-specieslist.csv")

## Common name
common <- codeKey %>%
            filter(DS.code == sp.code) %>%
            pull(SSAR.common)
common

## All species codes used (some species are complexes or have subspecies so multiple codes exist)
sp.code.all <- codeKey %>%
                filter(DS.code == sp.code) %>%
                pull(all.codes)
sp.code.all

## Scientific name
sciname <- codeKey %>%
            filter(DS.code == sp.code) %>%
            pull(SSAR.scientific)
sciname

## Save genus name to assign Frog/Toad or Salamander
gen <- stringr::word(sciname, 1)

if (gen %in% c("Acris", "Anaxyrus", "Aquarana", "Ascaphus",
               "Craugastor", "Dendrobates", "Dryophytes", "Eleutherodactylus",
               "Gastrophryne", "Glandirana", "Hyla", "Hypopachus", "Incilius",
               "Leptodactylus", "Lithobates", "Osteopilus",
               "Pseudacris", "Rana", "Rhinella", "Rhinophrynus",
               "Scaphiopus", "Smilisca", "Spea", "Xenopus")) spp.type <- "Frog/Toad"
if (gen %in% c("Ambystoma", "Amphiuma", "Aneides", "Batrachoseps",
               "Cryptobranchus", "Desmognathus", "Dicamptodon",
               "Ensatina", "Eurycea", "Gyrinophilus", "Hemidactylium",
               "Hydromantes", "Necturus", "Notophthalmus",
               "Phaeognathus", "Plethodon", "Pseudobranchus",
               "Pseudotriton", "Rhyacotriton", "Siren",
               "Stereochilus", "Taricha", "Urspelerpes")) spp.type <- "Salamander"

gen; spp.type
```



```{r species-data}
# get all files that have data for that species
allfiles <- read.csv("data/00-data-summary-flexiSDM.csv") %>%
  filter(Species == sp.code) %>%
  rename(file.name = Data.Swamp.file.name,
         file.label = Name,
         covar.mean = Covar.mean,
         covar.sum = Covar.sum,
         data.type = Type.true) %>%
  select(file.name, file.label, covar.mean, covar.sum, data.type, PO.extent)

head(allfiles)
```


NEED THESE TO LOAD SPECIES DATA
NEED A LIST SAME LENGTH AS FILE VECTOR WHERE EACH ELEMENT IS A DETECTION COVARIATE

```{r load-species-data}
species.data <- load_species_data(sp.code,
                                  sp.code.all,
                                  file.info = allfiles,
                                  file.path = "data/data-ready/",
                                  region = region, 
                                  filter.region = filter.region,
                                  year.start = year.start,
                                  year.end = year.end,
                                  coordunc = coordunc,
                                  coordunc_na.rm = coordunc_na.rm,
                                  spat.thin = spat.bal,
                                  keep.conus.grid.id = gridkey$conus.grid.id[which(gridkey$group == "train")])

```




## Step 4: Plot species data


WE PROBABLY DON'T NEED TO INCLUDE ALL OF THE FIGURES THAT WE MAKE, SO LET'S CHOOSE A FEW TO HIGHLIGHT

```{r plot-species-data-samples}
## Quick title to be used across figures
if (block == "none") {
  title <- ", full model"
} else {
  title <- paste0(", excluding block ", block)
}

## Plot data samples
pl <- map_species_data(region = region,
                       species.data = species.data,
                       year.start = year.start,
                       year.end = year.end,
                       plot = "samples",
                       plot.region = T,
                       details = F,
                       title = paste0(common, " (", sp.code, ")", title))
## Save plot
ggsave(pl, file = paste0(out.dir, "2_inputmap-a_data-", blockname, ".jpg"),
       height = 8, width = 10)
```

![IMAGE](C:/Users/rmummah/OneDrive - DOI/Documents/GitHub/iSDM-framework/outputs/3_RACA_subrange/2_inputmap-a_data-full.jpg)

```{r cv-plots}
## Cross-validation block-specific plots
if (block.out != "none") {

  pl <- map_species_data(region = region,
                         species.data = species.data,
                         year.start = year.start,
                         year.end = year.end,
                         plot = "samples",
                         plot.blocks = T,
                         blocks = spatblocks[which(spatblocks$folds == block),],
                         plot.region = T,
                         details = F,
                         title = paste0(common, " (", sp.code, ")", title))
  ggsave(pl, file = paste0(out.dir, "2_inputmap-c_blocks-", blockname, ".jpg"),
         height = 8, width = 10)
} else {
  # Plot
  pl <- map_species_data(region = region,
                         species.data = species.data,
                         year.start = year.start,
                         year.end = year.end,
                         plot = "samples",
                         plot.blocks = T,
                         blocks = spatblocks,
                         plot.region = T,
                         details = F,
                         title = paste0(common, " (", sp.code, ")", title))
  ggsave(pl, file = paste0(out.dir, "2_inputmap-c_blocks-", blockname, ".jpg"),
         height = 8, width = 10)
}
```

![IMAGE](C:/Users/rmummah/OneDrive - DOI/Documents/GitHub/iSDM-framework/outputs/3_RACA_subrange/2_inputmap-c_blocks-full.jpg)

## Step 5: Load covariate data

ONLY GOING TO SHOW COVARIATE DATA LOADING FOR RACA
ADD INAT DATA FOR SIMILAR SPECIES
Downloading and assembling the covariate data takes some time but should be 
This step takes awhile depending on the size of the range. 

```{r cov-data}
if (sp.code == "RACA") {
  
  if (file.exists(paste0(data.dir, "covariates.rds"))) {
    covar <- read_rds(paste0(data.dir, "covariates.rds"))
  } else {
    
    # Note that elevation data must be downloaded before running get_elevation()
    # We have downloaded the elevation and waterbody data outside of this repo
    # See documentation for details.
    tri <- get_elevation(locs = region$sp.grid, path = "../species-futures/data/USA/",
                         id.label = "conus.grid.id")
    waterbody <- get_waterbodies(locs = region$sp.grid, path = "../species-futures/data/USA/",
                                 id.label = "conus.grid.id")
    
    footprint <- get_footprint(locs = region$sp.grid, id.label = "conus.grid.id")
    climate <- get_climate(locs = region$sp.grid, id.label = "conus.grid.id")
    traveltime <- get_traveltime(locs = region$sp.grid, id.label = "conus.grid.id")
    
    covar <- full_join(tri, footprint, by = "conus.grid.id") %>%
              full_join(climate, by = "conus.grid.id") %>%
              full_join(waterbody, by = "conus.grid.id") %>%
              full_join(traveltime, by = "conus.grid.id") %>%
              mutate(sqrtarea_small = sqrt(area_small),
                     sqrtarea_medium = sqrt(area_medium)) %>%
              select(conus.grid.id, sqrtarea_small, sqrtarea_medium, 
                     footprint, TRI, tmin, traveltime)
    
    covar <- covar[order(match(covar$conus.grid.id, region$sp.grid$conus.grid.id)),]
    write_rds(covar, file = paste0(data.dir, "covariates.rds"))
    
  }
  
}
```

Next we remove grid cells which do not have complete covariates

```{r incomplete-covs}
## Remove incomplete cases
rm <- which(complete.cases(covar[,covs.z]) == F)
if (length(rm) > 0) {
  covar <- covar[-rm,]
  region$sp.grid <- region$sp.grid[-rm,]
}
```

Finally we scale all covariates to have a mean of 1 and a standard deviation of 0.

```{r scale-covs}
## Scale covariates 
covar_unscaled <- covar
numcols <- sapply(covar, is.numeric)
numcols <- which(numcols)
covar[,numcols] <- sapply(covar[,numcols], scale_this)
```

There's one additional step that could be done here. If removing collinearity is desired, the following piece of code would check and remove covariates that violate the 0.4 correlation threshold. If there are fewer than 3 covariates remaining after the procedure, then message will alert you.

```{r collinearity, eval=F}
# remove covariates that are correlated > 0.4
if (check.covs == T){

  threshold <- 0.4
  if (sp.code == "PJOR") threshold <- 0.45

  covs.rm <- select_covar(covs.z, threshold = threshold)
  covs.lin <- covs.lin[-which(covs.lin %in% covs.rm)]
  covs.quad <- covs.quad[-which(covs.quad %in% covs.rm)]

  covs.z <- c(covs.lin, covs.quad)
}

if (length(covs.z) < 3) {
  stop("There are fewer than 3 covariates remaining! This probably isn't a good model")
}
```

## Step 6: Plot covariates

```{r plot-covs}
if (block.out == "none") {
  
  ## Distribution covariates
  
  ## Define covariate labels
  covlabs <- read.csv("data/covariate-labels.csv") %>% filter(covariate %in% covs.z)
  
  plot_covar(covar,
             region,
             cov.names = covlabs$covariate,
             cov.labels = covlabs$Label,
             out.path = out.dir,
             out.name = "1_covariates-a_process-map")
  
  cor_covar(covar, 
            cov.names = covlabs$covariate,
            cov.labels = covlabs$Label,
            out.path = out.dir,
            out.name = "1_covariates-a_process-correlations", 
            color.threshold = 0.25)
  
  ## iNat covariates
  if ("iNaturalist" %in% names(species.data$obs)) {
    ## Define covariate labels
    covlabs <- read.csv("data/covariate-labels.csv") %>%
                filter(covariate %in% covs.inat)
    
    plot_covar(covar,
               region,
               cov.names = covlabs$covariate,
               cov.labels = covlabs$Label,
               out.path = out.dir,
               out.name = "1_covariates-b_iNat-map")
    
    if (length(covs.inat) > 1) {
      cor_covar(covar, 
                cov.names = covlabs$covariate,
                cov.labels = covlabs$Label,
                out.path = out.dir,
                out.name = "1_covariates-b_iNat-correlations", 
                color.threshold = 0.25)
    }
  }
  
  ## PO covs
  
  ## Define covariate labels
  covlabs <- read.csv("data/covariate-labels.csv") %>%
              filter(covariate %in% covs.PO)
  
  plot_covar(covar,
             region,
             cov.names = covlabs$covariate,
             cov.labels = covlabs$Label,
             out.path = out.dir,
             out.name = "1_covariates-c_PO-map")
  
  if (length(covs.PO) > 1) {
    cor_covar(covar, 
              cov.names = covlabs$covariate,
              cov.labels = covlabs$Label,
              out.path = out.dir,
              out.name = "1_covariates-c_PO-correlations", 
              color.threshold = 0.25)
  }
}
```

![IMAGE](C:/Users/rmummah/OneDrive - DOI/Documents/GitHub/iSDM-framework/outputs/3_RACA_subrange/2_inputmap-c_blocks-full.jpg)

![IMAGE](C:/Users/rmummah/OneDrive - DOI/Documents/GitHub/iSDM-framework/outputs/3_RACA_subrange/1_covariates-a_process-map.jpg)

![IMAGE](C:/Users/rmummah/OneDrive - DOI/Documents/GitHub/iSDM-framework/outputs/3_RACA_subrange/1_covariates-a_process-correlations.jpg)



<!-- # add centroid lat and lon of each grid cell to covar -->
<!-- centroid <- sf::st_centroid(region$sp.grid) %>% -->
<!--               sf::st_coordinates() %>% -->
<!--               as.data.frame() %>% -->
<!--               dplyr::mutate(conus.grid.id = region$sp.grid$conus.grid.id) -->

<!-- colnames(centroid)[1:2] <- c("lon", "lat") -->
<!-- covar <- dplyr::left_join(covar, centroid, by = "conus.grid.id") -->



<!-- ### Read in process covariates ---- -->
<!-- covs.z <- c(covs.lin, covs.quad, covs.int.factor) -->
<!-- if ("" %in% covs.z) { -->
<!--   covs.z <- covs.z[-which(covs.z == "")]   -->
<!-- } -->
<!-- if (NA %in% covs.z) { -->
<!--   covs.z <- covs.z[-which(is.na(covs.z))] -->
<!-- } -->



<!--   if (sp.code == "RACA") { -->

<!--   rain <- read_rds("data/species/RACA/rain-grid.rds") -->

<!--   covar <- left_join(covar, select(rain, !sp.grid.id), by = c("conus.grid.id")) %>% -->
<!--             mutate(sqrtarea_small = sqrt(area_small), -->
<!--                    sqrtarea_medium = sqrt(area_medium)) -->



<!-- } else if (sp.code == "GPOR") { -->

<!--   cwd <- read_rds("data/species/GPOR/cwd-grid.rds") -->
<!--   rain <- read_rds("data/species/GPOR/rain-grid.rds") -->
<!--   soilwater <- read_rds("data/species/GPOR/soilwater-grid.rds") -->
<!--   climate_velocity <- read_rds("data/species/GPOR/climate_velocity.rds") -->

<!--   covar <- left_join(covar, select(cwd, !sp.grid.id), by = c("conus.grid.id")) %>% -->
<!--             left_join(select(rain, !sp.grid.id), by = c("conus.grid.id")) %>% -->
<!--             left_join(select(soilwater, !sp.grid.id), by = c("conus.grid.id")) %>% -->
<!--             left_join(select(climate_velocity, !sp.grid.id), by = c("conus.grid.id")) -->


<!-- } else if (sp.code == "PLSE") { -->

<!--   if (buffer == 1) regs <- c("east", "west", "west", "west", "west") -->
<!--   if (buffer == 100000) regs <- c("east", "west", "west") -->
<!--   reg <- region$region %>% -->
<!--           st_cast("POLYGON") %>% -->
<!--           mutate(region = regs) -->

<!--   grid <- region$sp.grid %>% -->
<!--           st_intersection(reg) %>% -->
<!--           st_drop_geometry() -->

<!--   covar <- covar %>% -->
<!--             mutate(N_all = N + NW + NE) %>% -->
<!--             full_join(grid, by = c("conus.grid.id")) -->



<!-- } -->






<!-- ### Clean up PO covariates ---- -->
<!-- if (length(covs.inat) == 1) { -->
<!--   if (covs.inat == "" | is.na(covs.inat)) covs.inat <- NULL -->
<!-- } -->
<!-- if (length(covs.PO) == 1) { -->
<!--   if (covs.PO == "" | is.na(covs.PO)) covs.PO <- NULL -->
<!-- } -->


<!-- ### Plot covariates ---- -->
<!-- if (block.out == "none") { -->


<!--   # Process covs -->

<!--   # get covariate labels -->
<!--   covlabs <- read.csv("data/covariate-labels.csv") %>% filter(covariate %in% covs.z) -->

<!--   plot_covar(covar, -->
<!--              region, -->
<!--              cov.names = covlabs$covariate, -->
<!--              cov.labels = covlabs$Label, -->
<!--              out.path = out.dir, -->
<!--              out.name = "1_covariates-a_process-map") -->

<!--   cor_covar(covar,  -->
<!--             cov.names = covlabs$covariate, -->
<!--             cov.labels = covlabs$Label, -->
<!--             out.path = out.dir, -->
<!--             out.name = "1_covariates-a_process-correlations",  -->
<!--             color.threshold = 0.25) -->



<!--   # iNat covs -->

<!--   # get covariate labels -->

<!--   covlabs <- read.csv("data/covariate-labels.csv") %>% -->
<!--     filter(covariate %in% covs.inat) -->

<!--   if (length(covs.inat) > 0) { -->
<!--     plot_covar(covar, -->
<!--                region, -->
<!--                cov.names = covlabs$covariate, -->
<!--                cov.labels = covlabs$Label, -->
<!--                out.path = out.dir, -->
<!--                out.name = "1_covariates-b_iNat-map") -->

<!--     if (length(covs.inat) > 1) { -->
<!--       cor_covar(covar,  -->
<!--                 cov.names = covlabs$covariate, -->
<!--                 cov.labels = covlabs$Label, -->
<!--                 out.path = out.dir, -->
<!--                 out.name = "1_covariates-b_iNat-correlations",  -->
<!--                 color.threshold = 0.25) -->
<!--     } -->
<!--   } -->



<!--   # PO covs -->

<!--   # get covariate labels -->
<!--   covlabs <- read.csv("data/covariate-labels.csv") %>% -->
<!--     filter(covariate %in% covs.PO) -->

<!--   if (length(covs.PO)) { -->
<!--     plot_covar(covar, -->
<!--                region, -->
<!--                cov.names = covlabs$covariate, -->
<!--                cov.labels = covlabs$Label, -->
<!--                out.path = out.dir, -->
<!--                out.name = "1_covariates-c_PO-map") -->

<!--     if (length(covs.PO) > 1) { -->
<!--       cor_covar(covar,  -->
<!--                 cov.names = covlabs$covariate, -->
<!--                 cov.labels = covlabs$Label, -->
<!--                 out.path = out.dir, -->
<!--                 out.name = "1_covariates-c_PO-correlations",  -->
<!--                 color.threshold = 0.25) -->
<!--     } -->
<!--   } -->

<!-- } -->



<!-- ### Add quadratic covariates and interactions ---- -->
<!-- if (length(covs.quad) > 0 & paste0(covs.quad, collapse = "") != "") { -->
<!--   for (c in 1:length(covs.quad)) { -->
<!--     covar[,paste0(covs.quad[c], "2")] <- covar[,covs.quad[c]] * covar[,covs.quad[c]] -->
<!--     covs.z <- c(covs.z, paste0(covs.quad[c], "2")) -->
<!--   } -->
<!-- } -->

<!-- # and interactions -->
<!-- if (length(covs.int.factor) == 1 & is.na(covs.int.factor) == F) { -->

<!--   # pivot factor wider to get dummy cols -->
<!--   covar[,covs.int.factor] <- paste0(covs.int.factor, ".", covar[,covs.int.factor]) -->
<!--   covar <- covar %>% -->
<!--             mutate(fact = 1) %>% -->
<!--             pivot_wider(names_from = all_of(covs.int.factor), values_from = fact, values_fill = 0) -->

<!--   covs.z <- c(covs.z, colnames(covar)[grep(paste0(covs.int.factor, "."), colnames(covar))]) -->

<!--   for (j in 1:length(covs.int.cont)) { -->
<!--     # add interaction -->
<!--     tmp <- add_int_cols(covar, int.factor = covs.int.factor, int.cont = covs.int.cont[j]) -->
<!--     covar <- tmp$covar -->
<!--     covs.z <- c(covs.z, tmp$names) -->
<!--   } -->

<!--   # remove reference level -->
<!--   rm <- grep(reference, covs.z) -->
<!--   covs.z <- covs.z[-rm] -->

<!--   # remove original column name -->
<!--   rm <- grep(covs.int.factor, covs.z)[1] -->
<!--   covs.z <- covs.z[-rm] -->
<!-- } -->




<!-- # Make spatkey ---- -->

<!-- if (coarse.grid == T) { -->
<!--   spatRegion <- suppressWarnings(make_spatkey(region$sp.grid)) -->

<!--   # Print spatial grid -->
<!--   if (block.out == 'none') { -->
<!--     pl <- ggplot(spatRegion$spat.grid) + geom_sf() + theme_bw() -->
<!--     ggsave(pl, file = paste0(out.dir, "2_inputmap-e_spatGrid.jpg"), height = 8, width = 10) -->
<!--   } -->
<!-- } else { -->
<!--   spatRegion <- NULL -->
<!-- } -->






<!-- # NIMBLE ---- -->

<!-- # add grid.id to gridkey -->
<!-- gridkey$grid.id <- 1:nrow(gridkey) -->




<!-- summary <- read.csv("DATA SWAMP/00-data-summary-flexiSDM.csv") %>% -->
<!--             filter(Data.Swamp.file.name %in% allfiles$file, -->
<!--                    Name %in% names(species.data$obs)) %>% -->
<!--   select(-Data.Swamp.file.name) %>% -->
<!--   distinct() -->
<!-- summary <- summary[order(match(summary$Name, names(species.data$obs))),] %>% distinct() -->

<!-- sp.data <- sppdata_for_nimble(species.data, -->
<!--                               region, -->
<!--                               data.type = summary$Type.true, -->
<!--                               PO.extent = summary$PO.extent, -->
<!--                               covar = covar, -->
<!--                               covs.inat = covs.inat, -->
<!--                               covs.PO = covs.PO, -->
<!--                               covs.mean = summary$Covar.mean, -->
<!--                               covs.sum = summary$Covar.sum, -->
<!--                               offset.area = rep("", nrow(summary)), -->
<!--                               DND.maybe = 1, -->
<!--                               keep.conus.grid.id = gridkey$conus.grid.id[which(gridkey$group == "train")]) # get rid of PO cells that are in the wrong grid cells -->


<!-- ### Data/constants ---- -->
<!-- tmp <- data_for_nimble(sp.data, covar = covar, covs.z, -->
<!--                        sp.auto = sp.auto, coarse.grid = coarse.grid, region = region, -->
<!--                        process.intercept = process.intercept, -->
<!--                        gridkey = gridkey, spatRegion= spatRegion) -->

<!-- data <- tmp$data -->
<!-- constants <- tmp$constants -->


<!-- # Add state indicator variable for iNat data to indicate which states have taxon geoprivacy -->
<!-- # Add state indicator for multi-state PO to indicate which states have data -->
<!-- constants <- add_state_ind(species.data, -->
<!--                            region, -->
<!--                            gridkey, -->
<!--                            constants, -->
<!--                            covs.inat = covs.inat, -->
<!--                            obsc.state = obsc.state, -->
<!--                            keep.conus.grid.id = gridkey$conus.grid.id[which(gridkey$group == "train")]) -->


<!-- if (sp.code == "ANMI") { -->

<!--   # Need to replace NMGFD datasets with Bernoulli instead of occupancy -->
<!--   for (s in 1:length(species.data$obs)) { -->
<!--     nm <- constants[[paste0("name", s)]] -->
<!--     nm <- gsub(" .*", "", nm) -->

<!--     if (nm %in% c("NMGFD", "AZGFD")) { -->
<!--       constants[[paste0("nVisitsV", s)]] <- 1 -->
<!--     } -->
<!--   } -->

<!-- } -->



<!-- if (model == "proj08nostate") { -->
<!--   if (sp.code == "EBIS") { -->
<!--     data$Xw3$WV <- NULL -->
<!--     data$Xw3$VT <- NULL -->
<!--     data$S3 <- NULL -->

<!--     constants$nCovW3 <- ncol(data$Xw3) -->
<!--   } else { -->
<!--     stop("Don't know which states to remove") -->
<!--   } -->

<!--   rm.state <- T -->
<!-- } else { -->
<!--   rm.state <- F -->
<!-- } -->



<!-- ### Code ---- -->
<!-- code <- nimble_code(data, -->
<!--                     constants,  -->
<!--                     path = out.dir, -->
<!--                     sp.auto = sp.auto,  -->
<!--                     coarse.grid = coarse.grid, -->
<!--                     Bpriordist = Bpriordist, Bpriorvar1 = Bpriorvar1, Bpriorvar2 = Bpriorvar2, -->
<!--                     block.out = block.out, -->
<!--                     min.visits.incl = 3,  -->
<!--                     zero_mean = zero_mean, -->
<!--                     tau = tau, -->
<!--                     rm.state = rm.state) -->

<!-- ### Initial values ---- -->
<!-- inits <- function(x){nimble_inits(data, -->
<!--                                   constants, -->
<!--                                   sp.auto = sp.auto, -->
<!--                                   seed = x)} -->

<!-- ### Parameters ---- -->
<!-- params <- nimble_params(data, -->
<!--                         constants, -->
<!--                         lambda = T, -->
<!--                         XB = T, -->
<!--                         sp.auto = sp.auto, -->
<!--                         effort = T) -->


<!-- source("code/03-species-models/xx-flexiSDM-setuptests.R") -->


<!-- end1 <- Sys.time() - start1 -->

<!-- # Remove local and block in case the setup is run locally but the model is fit on the HPC. -->
<!-- # Remove other unnecessary files to reduce the size of setup_BLOCK.Rdata -->
<!-- rm(list=c('local','block','args','conus.covar.grid','conus.grid','usa','conus', -->
<!--           'pl','centroid')) -->


<!-- # Save environment and full set up -->
<!-- save.image(paste0(out.dir, "setup_",block.out,".Rdata")) -->


<!-- # End script - proceed to 02-flexiSDM.R -->

<!-- ## --------------------------- -->
<!-- ## Objective:  -->
<!-- ##    - Fit NIMBLE model using setup_BLOCK.rdata file -->
<!-- ##  -->
<!-- ## Input: -->
<!-- ##    - setup_BLOCK.rdata -->
<!-- ## -->
<!-- ## Output:  -->
<!-- ##    - samples_BLOCK_CHAIN.rds OR samples_BLOCK.rds -->
<!-- ## -->
<!-- ## --------------------------- -->

<!-- start2 <- Sys.time()  -->
<!-- print(paste0('Beginning 02-MVPv1.1 script at ', start2)) -->


<!-- # EDIT THIS SECTION ---- -->
<!-- num <- 1 -->
<!-- block <- "none" -->
<!-- sp.code <- "RACA" -->
<!-- model <- "WIPtest" -->
<!-- chain <- 1 -->
<!-- local <- 1 -->
<!-- # --- -->


<!-- args = commandArgs(trailingOnly = TRUE) -->

<!-- if (length(args) > 0) { -->
<!--   num = as.numeric(args[1]) -->
<!--   sp.code = as.character(args[2]) -->
<!--   model = as.character(args[3]) -->
<!--   block = as.numeric(args[4]) -->
<!--   chain = as.numeric(args[5]) -->
<!--   local = as.numeric(args[6])  -->

<!--   # If running on HPC, set working directory -->
<!--   if (local == 0) { -->
<!--     setwd('/caldera/hovenweep/projects/usgs/ecosystems/eesc/rmummah/species-futures/') -->
<!--   }  -->
<!-- } -->

<!-- # Ensure block is coded correctly -->
<!-- if (block == 4) { -->
<!--   block <- 'none' -->
<!-- } -->


<!-- # Load functions and packages -->
<!-- suppressMessages(source("functions/FXN-nimbleParallel.R")) -->
<!-- library(SpFut.flexiSDM) -->


<!-- # Set output directory and load setup file -->
<!-- out.dir = paste0('outputs/03-species-models/MVPv1/',num,'_',sp.code,'_',model,'/') -->
<!-- load(paste0(out.dir,'setup_',block,'.Rdata')) -->


<!-- # Fit NIMBLE model ---- -->
<!-- if (local == 1) { -->
<!--   start.nim <- Sys.time() -->
<!--   samples <- nimbleParallel(code = code, -->
<!--                             data = data, -->
<!--                             constants = constants, -->
<!--                             inits = inits, -->
<!--                             param = params, -->
<!--                             iter = iter, -->
<!--                             burnin = burnin, -->
<!--                             thin = thin) -->

<!--   end.nim <- Sys.time() - start.nim -->
<!--   print(end.nim) -->

<!--   saveRDS(samples, paste0(out.dir,'samples_',block,'.rds')) -->
<!-- } else { -->

<!--   info <- list(seed = chain, -->
<!--                inits = inits(chain)) -->

<!--   start.nim <- Sys.time() -->
<!--   samples <- run_nimbleMCMC(info = info,  -->
<!--                             code = code,  -->
<!--                             constants = constants,  -->
<!--                             data = data,  -->
<!--                             param = params,  -->
<!--                             iter = iter,  -->
<!--                             burnin = burnin,  -->
<!--                             thin = thin) -->

<!--   end.nim <- Sys.time() - start.nim -->
<!--   print(end.nim) -->

<!--   saveRDS(samples, paste0(out.dir,'samples_',block,'_',chain,'.rds')) -->
<!-- } -->


<!-- end2 <- Sys.time() - start2 -->
<!-- saveRDS(end2, paste0(out.dir,'time2_',block,'.rds')) -->
<!-- print(end2) -->

<!-- # End script - proceed to 03-flexiSDM.R -->

<!-- ## --------------------------- -->
<!-- ## Objective:  -->
<!-- ##    - Fit NIMBLE model using setup_BLOCK.rdata file -->
<!-- ##  -->
<!-- ## Input: -->
<!-- ##    - setup_BLOCK.rdata -->
<!-- ##    - samples_BLOCK_CHAIN.rds OR samples_BLOCK.rds -->
<!-- ## -->
<!-- ## Output:  -->
<!-- ##    - samples_BLOCK_CHAIN.rds OR samples_BLOCK.rds -->
<!-- ## -->
<!-- ## --------------------------- -->

<!-- start3 <- Sys.time() -->


<!-- ## load packages ---- -->
<!-- library(tidyverse, quietly = T) -->
<!-- library(magrittr, quietly = T) -->
<!-- library(sf, quietly = T) -->
<!-- library(SpFut.flexiSDM) -->



<!-- # EDIT THIS SECTION ---- -->
<!-- num <- 108 -->
<!-- block <- "none" -->
<!-- sp.code <- "RACA" -->
<!-- model <- "tau1" -->
<!-- maxchain <- 3 -->
<!-- local <- 1 -->
<!-- # --- -->


<!-- # Setup ---- -->
<!-- args = commandArgs(trailingOnly = TRUE) -->

<!-- if (length(args) > 0) { -->
<!--   num = as.numeric(args[1]) -->
<!--   sp.code = as.character(args[2]) -->
<!--   model = as.character(args[3]) -->
<!--   block = as.numeric(args[4]) -->
<!--   maxchain = as.numeric(args[5]) -->
<!--   local = as.numeric(args[6]) -->

<!--   if (local == 0) { -->
<!--     setwd('/caldera/hovenweep/projects/usgs/ecosystems/eesc/rmummah/species-futures/') -->
<!--   }  -->

<!-- } -->

<!-- # Ensure block is coded correctly -->
<!-- if (block == 4) { -->
<!--   block <- 'none' -->
<!-- } -->

<!-- # load output directory, setup, and functions -->
<!-- out.dir = paste0('outputs/03-species-models/MVPv1/',num,'_',sp.code,'_',model,'/') -->
<!-- load(paste0(out.dir,'setup_',block,'.Rdata')) -->




<!-- # Load chains (samples) ---- -->

<!-- if (file.exists(paste0(out.dir,'samples_',block,'.rds'))) { # If it was run locally, this file should exist -->
<!--   samples <- readRDS(paste0(out.dir,'samples_',block,'.rds')) -->
<!-- } else { -->
<!--   # Load individual sample files and save as a list -->
<!--   samples <- lapply(1:maxchain,  -->
<!--                     FUN = function(x) { -->
<!--                       readRDS(paste0(out.dir,'samples_',block,'_',x,'.rds')) -->
<!--                     }) -->
<!-- } -->



<!-- ## Calculate derived quantities ---- -->
<!-- # This takes longer with the coarse grid. -->
<!-- samples <- lapply(samples, get_derived, data = data, project = project,  -->
<!--                   coarse.grid = coarse.grid, spatRegion = spatRegion, -->
<!--                   pathToProj = 'code/03-species-models/setup-projections.R') -->


<!-- # Plot chains before summarizing -->
<!-- cov.labs <- read.csv("data/covariate-labels.csv") -->

<!-- ### Chains ---- -->
<!-- ggsave(plot_chains(samples, data = data, cov.labs = cov.labs, plot = "B", cutoff = 0), file = paste0(out.dir, "3_parameters-a1_chains-B-",block,".jpg"), height = 6, width = 8) -->
<!-- ggsave(plot_chains(samples, data = data, cov.labs = cov.labs, plot = "alpha", cutoff = 0), file = paste0(out.dir, "3_parameters-b1_chains-alpha-",block,".jpg"), height = 6, width = 8) -->
<!-- ggsave(plot_chains(samples, data = data, cov.labs = cov.labs, plot = "tau", cutoff = 0), file = paste0(out.dir, "3_parameters-b1_chains-tau-",block,".jpg"), height = 6, width = 8) -->

<!-- # Posteriors ---- -->
<!-- ggsave(plot_posteriors(samples, data = data, cov.labs = cov.labs, plot = "B", cutoff = 0), file = paste0(out.dir, "3_parameters-a2_posteriors-B.jpg"), height = 6, width = 8) -->
<!-- ggsave(plot_posteriors(samples, data = data, cov.labs = cov.labs, plot = "alpha", cutoff = 0), file = paste0(out.dir, "3_parameters-b2_posteriors-alpha.jpg"), height = 6, width = 8) -->


<!-- ## Summarize chains ---- -->
<!-- out <- summarize_samples(samples,  -->
<!--                          data,  -->
<!--                          constants,  -->
<!--                          project = project, -->
<!--                          coarse.grid = coarse.grid, -->
<!--                          block.out = block.out, -->
<!--                          gridkey = gridkey,  -->
<!--                          spatkey = spatRegion$spatkey, -->
<!--                          effort = T, -->
<!--                          SLURM = ifelse(local == 1, F, T)) -->

<!-- save(out, file = paste0(out.dir, "data", blockname, ".rdata")) -->



<!-- # Plot output ---- -->

<!-- # Convergence -->
<!-- ggsave(plot_convergence(out), file = paste0(out.dir, "3_parameters-0_convergence-", block, ".jpg"), -->
<!--        height = 5, width = 12) -->

<!-- if (block.out == "none") { -->

<!--   ### Parameter estimates ---- -->
<!--   ggsave(plot_pars(out,  -->
<!--                    plot.type = "full",  -->
<!--                    plot.group = "process",  -->
<!--                    title = "Process parameter estimates", -->
<!--                    cov.labs = cov.labs), -->
<!--          file = paste0(out.dir, "3_parameters-a3_B.jpg"), height = 6, width = 10) -->

<!--   ggsave(plot_pars(out,  -->
<!--                    plot.type = "full",  -->
<!--                    plot.group = "observation",  -->
<!--                    title = "Observation parameter estimates", -->
<!--                    cov.labs = cov.labs), -->
<!--          file = paste0(out.dir, "3_parameters-b3_alpha.jpg"), height = 6, width = 10) -->

<!--   ggsave(plot_pars(out,  -->
<!--                    plot.type = "full",  -->
<!--                    plot.group = "dataset",  -->
<!--                    title = "Dataset intercept estimates"), -->
<!--          file = paste0(out.dir, "3_parameters-c3_observation.jpg"), height = 6, width = 10) -->

<!--   ggsave(plot_pars(out,  -->
<!--                    plot.type = "full",  -->
<!--                    plot.group = "tau",  -->
<!--                    title = "Tau estimate"), -->
<!--          file = paste0(out.dir, "3_parameters-c3_tau.jpg"), height = 6, width = 10) -->

<!--   ### Marginal effects ---- -->
<!--   ggsave(plot_effects(data, out, breaks = 0.001), file = paste0(out.dir, "/3_parameters-a4-effects.jpg"), height = 7, width = 10) -->




<!--   ### Plot effort and PO records ---- -->

<!--   tmp <- full_join(select(out$effort, conus.grid.id, PO.dataset.name, mean), select(out$lambda0, conus.grid.id, mean), by = "conus.grid.id") %>% -->
<!--     rename(mean.effort = mean.x, -->
<!--            mean.lambda = mean.y) -->

<!--   ind <- grep("nW", names(constants)) -->
<!--   nums <- gsub("nW", "", names(constants)[ind]) -->

<!--   dat <- c() -->
<!--   for (i in 1:length(nums)) { -->
<!--     dat1 <- data.frame(W = data[[paste0("W", nums[i])]], -->
<!--                        grid.id = constants[[paste0("Wcells", nums[i])]], -->
<!--                        PO.dataset.name = constants[[paste0("name", nums[i])]]) -->

<!--     dat <- bind_rows(dat, dat1) -->
<!--   } -->
<!--   dat <- dat %>% -->
<!--     full_join(gridkey, by = "grid.id") -->

<!--   tmp1 <- full_join(tmp, dat, by = c("conus.grid.id", "PO.dataset.name")) %>% -->
<!--     mutate(recpereff = W / mean.effort, -->
<!--            adjlambda = mean.effort * mean.lambda) -->

<!--   pl <- ggplot(tmp1) + -->
<!--     geom_point(aes(x = recpereff, y = mean.lambda), alpha = 0.5) + -->
<!--     geom_smooth(aes(x = recpereff, y = mean.lambda), method = "lm") + -->
<!--     facet_wrap(~ PO.dataset.name, scales = "free") + -->
<!--     theme_bw() + -->
<!--     labs(x = "Number of records per unit of effort", y = "Estimated lambda") -->
<!--   ggsave(pl, file = paste0(out.dir, "/X_recordspereffort.jpg"), height = 8, width = 8) -->

<!--   pl <- ggplot(tmp1) + -->
<!--     geom_point(aes(x = mean.effort, y = W), alpha = 0.5) + -->
<!--     geom_smooth(aes(x = mean.effort, y = W), method = "lm") + -->
<!--     facet_wrap(~ PO.dataset.name, scales = "free") + -->
<!--     theme_bw() + -->
<!--     labs(x = "Estimated effort", y = "Number of records") -->
<!--   ggsave(pl, file = paste0(out.dir, "/X_recordsvseffort.jpg"), height = 8, width = 8) -->


<!--   ### Maps ---- -->
<!--   # Current -->
<!--   pl <- map_species_data(title = paste0(common, " (", sp.code, ")"),  -->
<!--                          region,  -->
<!--                          plot = "lambda", -->
<!--                          out = out) -->
<!--   ggsave(pl, file = paste0(out.dir, "4_mapcurrent-a_lambda.jpg"), height = 7, width = 9) -->

<!--   pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                          region,  -->
<!--                          plot = "lambda", -->
<!--                          out = out,  -->
<!--                          plot.uncertainty = "unc.range") -->
<!--   ggsave(pl, file = paste0(out.dir, "4_mapcurrent-a_lambda-uncabs.jpg"), height = 7, width = 9) -->

<!--   pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                          region, -->
<!--                          plot = "lambda", -->
<!--                          out = out,  -->
<!--                          plot.uncertainty = "unc.rel") -->
<!--   ggsave(pl, file = paste0(out.dir, "4_mapcurrent-a_lambda-uncrel.jpg"), height = 7, width = 9) -->

<!--   pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                          region, -->
<!--                          plot = "psi", -->
<!--                          out = out) -->
<!--   ggsave(pl, file = paste0(out.dir, "4_mapcurrent-b_psi.jpg"), height = 7, width = 9) -->

<!--   pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                          region, -->
<!--                          plot = "psi", -->
<!--                          out = out,  -->
<!--                          plot.uncertainty = "unc.range") -->
<!--   ggsave(pl, file = paste0(out.dir, "4_mapcurrent-b_psi-uncabs.jpg"), height = 7, width = 9) -->

<!--   pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                          region, -->
<!--                          plot = "psi", -->
<!--                          out = out,  -->
<!--                          plot.uncertainty = "unc.rel") -->
<!--   ggsave(pl, file = paste0(out.dir, "4_mapcurrent-b_psi-uncrel.jpg"), height = 7, width = 9) -->

<!--   pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                          region, -->
<!--                          plot = "boundary", -->
<!--                          out = out,  -->
<!--                          threshold = 0.25) -->
<!--   ggsave(pl, file = paste0(out.dir, "4_mapcurrent-c1_boundary-0.25.jpg"), height = 7, width = 9) -->

<!--   pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                          region, -->
<!--                          plot = "boundary", -->
<!--                          out = out,  -->
<!--                          threshold = 0.5) -->
<!--   ggsave(pl, file = paste0(out.dir, "4_mapcurrent-c2_boundary-0.5.jpg"), height = 7, width = 9) -->

<!--   pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                          region, -->
<!--                          plot = "boundary", -->
<!--                          out = out,  -->
<!--                          threshold = 0.75) -->
<!--   ggsave(pl, file = paste0(out.dir, "4_mapcurrent-c3_boundary-0.75.jpg"), height = 7, width = 9) -->

<!--   if (sp.auto == T) { -->
<!--     pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                            region, -->
<!--                            plot = "spat", -->
<!--                            out = out, -->
<!--                            coarse.grid = coarse.grid, -->
<!--                            spatRegion = spatRegion) -->
<!--     ggsave(pl, file = paste0(out.dir, "4_mapcurrent-d_spat.jpg"), height = 7, width = 9) -->
<!--   } -->

<!--   pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                          region, -->
<!--                          plot = "XB", -->
<!--                          out = out, -->
<!--                          plot.exp = T) -->
<!--   ggsave(pl, file = paste0(out.dir, "4_mapcurrent-d_expXB.jpg"), height = 7, width = 9) -->


<!--   pl <- map_species_data(title = paste0(common, " (", sp.code, ")"),  -->
<!--                          region,  -->
<!--                          plot = "effort", -->
<!--                          out = out) -->
<!--   ggsave(pl, file = paste0(out.dir, "4_mapcurrent-e_effort.jpg"), height = 7, width = 9) -->

<!--   ### Future projections ---- -->
<!--   if (project > 0) { -->
<!--     pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                            region, -->
<!--                            plot = "lambda", -->
<!--                            out = out,  -->
<!--                            plot.current = F,  -->
<!--                            plot.change = F, -->
<!--                            proj.names = proj.names) -->
<!--     ggsave(pl, file = paste0(out.dir, "5_mapfuture-a_lambda.jpg"), height = 7, width = 9) -->

<!--     pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                            region, -->
<!--                            plot = "lambda", -->
<!--                            out = out,  -->
<!--                            plot.current = F,  -->
<!--                            plot.change = F,  -->
<!--                            plot.uncertainty = "unc.range", -->
<!--                            proj.names = proj.names) -->
<!--     ggsave(pl, file = paste0(out.dir, "5_mapfuture-a_lambda-uncabs.jpg"), height = 7, width = 9) -->

<!--     pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                            region, -->
<!--                            plot = "lambda", -->
<!--                            out = out,  -->
<!--                            plot.current = F,  -->
<!--                            plot.change = F,  -->
<!--                            plot.uncertainty = "unc.rel", -->
<!--                            proj.names = proj.names) -->
<!--     ggsave(pl, file = paste0(out.dir, "5_mapfuture-a_lambda-uncrel.jpg"), height = 7, width = 9) -->

<!--     pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                            region,  -->
<!--                            plot = "psi", -->
<!--                            out = out,  -->
<!--                            plot.current = F,  -->
<!--                            plot.change = F, -->
<!--                            proj.names = proj.names) -->
<!--     ggsave(pl, file = paste0(out.dir, "5_mapfuture-b_psi.jpg"), height = 7, width = 9) -->

<!--     pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                            region, -->
<!--                            plot = "psi", -->
<!--                            out = out,  -->
<!--                            plot.current = F,  -->
<!--                            plot.change = F,  -->
<!--                            plot.uncertainty = "unc.range", -->
<!--                            proj.names = proj.names) -->
<!--     ggsave(pl, file = paste0(out.dir, "5_mapfuture-b_psi-uncabs.jpg"), height = 7, width = 9) -->

<!--     pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                            region, -->
<!--                            plot = "psi", -->
<!--                            out = out,  -->
<!--                            plot.current = F,  -->
<!--                            plot.change = F,  -->
<!--                            plot.uncertainty = "unc.rel", -->
<!--                            proj.names = proj.names) -->
<!--     ggsave(pl, file = paste0(out.dir, "5_mapfuture-b_psi-uncrel.jpg"), height = 7, width = 9) -->

<!--     pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                            region, -->
<!--                            plot = "boundary", -->
<!--                            out = out,  -->
<!--                            plot.current = F,  -->
<!--                            plot.change = F,  -->
<!--                            threshold = 0.25, -->
<!--                            proj.names = proj.names) -->
<!--     ggsave(pl, file = paste0(out.dir, "5_mapfuture-c1_boundary-0.25.jpg"), height = 7, width = 9) -->

<!--     pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                            region, -->
<!--                            plot = "boundary", -->
<!--                            out = out,  -->
<!--                            plot.current = F,  -->
<!--                            plot.change = F,  -->
<!--                            threshold = 0.5, -->
<!--                            proj.names = proj.names) -->
<!--     ggsave(pl, file = paste0(out.dir, "5_mapfuture-c2_boundary-0.5.jpg"), height = 7, width = 9) -->

<!--     pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                            region, -->
<!--                            plot = "boundary", -->
<!--                            out = out,  -->
<!--                            plot.current = F,  -->
<!--                            plot.change = F,  -->
<!--                            threshold = 0.75, -->
<!--                            proj.names = proj.names) -->
<!--     ggsave(pl, file = paste0(out.dir, "5_mapfuture-c3_boundary-0.75.jpg"), height = 7, width = 9) -->

<!--     pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                            region, -->
<!--                            plot = "XB", -->
<!--                            out = out,  -->
<!--                            plot.exp = T, -->
<!--                            plot.current = F, -->
<!--                            proj.names = proj.names) -->
<!--     ggsave(pl, file = paste0(out.dir, "5_mapfuture-d_expXB-future.jpg"), height = 7, width = 9) -->


<!--     ### Future absolute change ---- -->
<!--     pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                            region, -->
<!--                            plot = "lambda", -->
<!--                            out = out,  -->
<!--                            plot.current = F,  -->
<!--                            plot.change = "absolute", -->
<!--                            proj.names = proj.names) -->
<!--     ggsave(pl, file = paste0(out.dir, "6_mapchange-a1_lambda-abs.jpg"), height = 7, width = 9) -->

<!--     pl <- map_species_data(title = paste0(common, " (", sp.code, ")"), -->
<!--                            region, -->
<!--                            plot = "psi", -->
<!--                            out = out,  -->
<!--                            plot.current = F,  -->
<!--                            plot.change = "absolute", -->
<!--                            proj.names = proj.names) -->
<!--     ggsave(pl, file = paste0(out.dir, "6_mapchange-b1_psi-abs.jpg"), height = 7, width = 9) -->

<!--     pl <- map_species_data(title = paste0(common, " (", sp.code, ")"),  -->
<!--                            region, -->
<!--                            plot = "boundary", -->
<!--                            out = out,  -->
<!--                            plot.current = F,  -->
<!--                            plot.change = "absolute",  -->
<!--                            threshold = 0.25, -->
<!--                            proj.names = proj.names) -->
<!--     ggsave(pl, file = paste0(out.dir, "6_mapchange-c1_boundary-abs-0.25.jpg"), height = 7, width = 9) -->

<!--     pl <- map_species_data(title = paste0(common, " (", sp.code, ")"),  -->
<!--                            region, -->
<!--                            plot = "boundary", -->
<!--                            out = out,  -->
<!--                            plot.current = F,  -->
<!--                            plot.change = "absolute",  -->
<!--                            threshold = 0.5, -->
<!--                            proj.names = proj.names) -->
<!--     ggsave(pl, file = paste0(out.dir, "6_mapchange-c2_boundary-abs-0.5.jpg"), height = 7, width = 9) -->

<!--     pl <- map_species_data(title = paste0(common, " (", sp.code, ")"),  -->
<!--                            region, -->
<!--                            plot = "boundary", -->
<!--                            out = out,  -->
<!--                            plot.current = F,  -->
<!--                            plot.change = "absolute",  -->
<!--                            threshold = 0.75, -->
<!--                            proj.names = proj.names) -->
<!--     ggsave(pl, file = paste0(out.dir, "6_mapchange-c3_boundary-abs-0.75.jpg"), height = 7, width = 9) -->

<!--     ### Future relative change ---- -->
<!--     pl <- map_species_data(title = paste0(common, " (", sp.code, ")"),  -->
<!--                            region, -->
<!--                            plot = "lambda", -->
<!--                            out = out,  -->
<!--                            plot.current = F,  -->
<!--                            plot.change = "relative", -->
<!--                            proj.names = proj.names) -->
<!--     ggsave(pl, file = paste0(out.dir, "6_mapchange-a2_lambda-rel.jpg"), height = 7, width = 9) -->

<!--     pl <- map_species_data(title = paste0(common, " (", sp.code, ")"),  -->
<!--                            region, -->
<!--                            plot = "psi",  -->
<!--                            out = out,  -->
<!--                            plot.current = F, -->
<!--                            plot.change = "relative", -->
<!--                            proj.names = proj.names) -->
<!--     ggsave(pl, file = paste0(out.dir, "6_mapchange-b2_psi-rel.jpg"), height = 7, width = 9) -->
<!--   } -->
<!-- } -->





<!-- # Validate ---- -->

<!-- # Get all data -->
<!-- species.data <- load_species_data(sp.code, -->
<!--                                   sp.code.all, -->
<!--                                   file.name = allfiles$file, -->
<!--                                   file.label = allfiles$name, -->
<!--                                   file.path = "DATA SWAMP/data-ready/", -->
<!--                                   keep.cols = covariates, -->
<!--                                   region = region,  -->
<!--                                   filter.region = filter.region, -->
<!--                                   year.start = year.start, -->
<!--                                   year.end = year.end, -->
<!--                                   coordunc = coordunc, -->
<!--                                   coordunc_na.rm = coordunc_na.rm, -->
<!--                                   spat.thin = spat.bal, -->
<!--                                   keep.conus.grid.id = gridkey$conus.grid.id) -->



<!-- all.auc <- get_AUC(species.data, out) -->



<!-- # Save everything ---- -->
<!-- if (block.out == "none") { -->
<!--   blockname <- "full" -->
<!--   save(region, file = paste0(out.dir, "region.rdata")) -->
<!-- } else {blockname <- block.out} -->

<!-- save(species.data, covar, covar_unscaled, data, constants, gridkey, all.auc, block.out, -->
<!--      file = paste0(out.dir, "data", blockname, "-info.rdata")) -->


<!-- # Final CV Figures ---- -->
<!-- # Make final cross validation figs if all blocks have been done -->

<!-- done <- list.files(path = out.dir) -->

<!-- mod.name <- c('data1','data2','data3','datafull') -->


<!-- if (all(c(paste0(mod.name, '.rdata'), paste0(mod.name, '-info.rdata')) %in% done)) { -->

<!--   # Load data from all model runs -->
<!--   auc <- c() -->
<!--   proc <- c() -->
<!--   obs <- c() -->
<!--   alpha <- c() -->
<!--   for (i in 1:3) { -->
<!--     load(paste0(out.dir, "data", i, "-info.rdata")) -->
<!--     load(paste0(out.dir, "data", i, ".rdata")) -->

<!--     # If validation data is missing, skip -->
<!--     if (length(all.auc) == 1) next -->

<!--     out$process.coef$block.out <- as.character(out$process.coef$block.out) -->
<!--     out$obs.coef$block.out <- as.character(out$obs.coef$block.out) -->
<!--     out$alpha$block.out <- as.character(out$alpha$block.out) -->

<!--     auc <- bind_rows(auc, all.auc) -->
<!--     proc <- bind_rows(proc, out$process.coef) -->
<!--     obs <- bind_rows(obs, out$obs.coef) -->
<!--     alpha <- bind_rows(alpha, out$alpha) -->

<!--   } -->

<!--   # If validation data exists... -->
<!--   if (!is.null(auc)) { -->

<!--     # now add full model -->
<!--     load(paste0(out.dir, "datafull.rdata")) -->

<!--     out$process.coef$block.out <- as.character(out$process.coef$block.out) -->
<!--     out$obs.coef$block.out <- as.character(out$obs.coef$block.out) -->
<!--     out$alpha$block.out <- as.character(out$alpha$block.out) -->

<!--     proc <- bind_rows(proc, out$process.coef) -->
<!--     obs <- bind_rows(obs, out$obs.coef) -->
<!--     alpha <- bind_rows(alpha, out$alpha) -->


<!--     load(paste0(out.dir, "datafull-info.rdata")) -->
<!--     auc$block <- as.character(auc$block) -->
<!--     auc <- bind_rows(auc, all.auc) -->


<!--     ggsave(plot_pars(out = proc,  -->
<!--                      plot.type = "cv",  -->
<!--                      plot.group = "process",  -->
<!--                      title = "Process parameter estimates", -->
<!--                      cov.labs = cov.labs), -->
<!--            file = paste0(out.dir, "7_CV-a-parameters-process.jpg"), height = 6, width = 10) -->

<!--     ggsave(plot_pars(out = alpha,  -->
<!--                      plot.type = "cv",  -->
<!--                      plot.group = "dataset",  -->
<!--                      title = "Dataset parameter estimates", -->
<!--                      cov.labs = cov.labs), -->
<!--            file = paste0(out.dir, "7_CV-b-parameters-dataset.jpg"), height = 6, width = 10) -->

<!--     ggsave(plot_pars(out = obs,  -->
<!--                      plot.type = "cv",  -->
<!--                      plot.group = "observation",  -->
<!--                      title = "Observation parameter estimates", -->
<!--                      cov.labs = cov.labs), -->
<!--            file = paste0(out.dir, "7_CV-a-parameters-observation.jpg"), height = 6, width = 10) -->


<!--     # Plot AUC -->
<!--     ggsave(plot_auc(auc, lines = T), file = paste0(out.dir, "7_CV-d_AUClines.jpg"), height = 7, width = 10) -->
<!--     ggsave(plot_auc(auc, lines = F), file = paste0(out.dir, "7_CV-d_AUCnolines.jpg"), height = 7, width = 10) -->
<!--   } -->
<!-- } -->


<!-- # Create time-summary output file ---- -->
<!-- cat("Summarization and visualization complete \n\n") -->

<!-- end3 <- Sys.time() - start3 -->

<!-- # Start output file -->
<!-- sink(paste0(out.dir,'time-summary_',block,'.txt')) -->

<!-- cat(paste0("Time summary for: ", nums.do,' ',sp.code,' ',model,'\n\n')) -->

<!-- cat(paste0('The model was run on ', format(Sys.time(), "%a %b %Y %d %X"),'\n\n')) -->


<!-- # Print total time to output file -->
<!-- cat('Total time for setup:\n') -->
<!-- print(end1) -->
<!-- cat('\n') -->

<!-- end2 <- readRDS(paste0(out.dir, 'time2_',block,'.rds')) -->
<!-- cat('Total time for fitting NIMBLE model: \n') -->
<!-- print(end2) -->
<!-- cat('\n') -->

<!-- cat('Total time for summarization: \n') -->
<!-- print(end3) -->
<!-- cat('\n') -->

<!-- cat('Start to finish time (code): \n') -->
<!-- print(end1 + end2 + end3) -->
<!-- cat('\n') -->

<!-- cat('Start to finish time (user delay): \n') -->
<!-- print(Sys.time() - start1) -->
<!-- cat('\n\n') -->

<!-- # Close output file -->
<!-- sink() -->

<!-- cat("Removing intermediate files...\n") -->
<!-- # system(paste0("rm ./outputs/03-species-models/MVPv1/",number,'_',sp.code,'_',model,"/setup_",block,"*")) -->
<!-- # system(paste0("rm ./outputs/03-species-models/MVPv1/",number,'_',sp.code,'_',model,"/samples_",block,"*")) -->
<!-- # system(paste0("rm ./outputs/03-species-models/MVPv1/",number,'_',sp.code,'_',model,"/time2_",block,".rds")) -->

<!-- cat(paste0("Model ",number,' ',sp.code,' ',model," complete!!\n")) -->


<!-- # End script -->


## High performance computing

We almost exclusively run these models on a high performance computing (HPC) cluster. We clone our repository directly to the HPC to ensure we have the same file structure and no version conflicts. We've set up the code so we can seamlessly move between running the workflow locally and on our HPC. 

To run the first steps of the workflow via `01-flexiSDM.R`, we call the script `01-flexiSDM.sh`, which takes 3 inputs: 

- Model number
- Block (defined by an array in the script)
- Local (1/0)

We have simplified this further by writing a wrapper called `01-HPC.sh`, which only takes one input: model number. Within the script, `local` is set to 0, indicating a run on an HPC.

The inputs provided to the `.sh` scripts are converted to inputs to the `01-flexiSDM.R` script and are interpreted below:

```{r hpc, eval = F}
# Converts command arguments to something interpretable by R
args = commandArgs(trailingOnly = TRUE)

if (length(args) > 0) {

  # Model number to run
  nums.do = as.numeric(args[1])

  # Blocks can be run as single jobs or as arrays
  block = as.numeric(args[2])
  
  # The block input is numeric only. Convert 4 = 'none'
  if (block == 4) {
    block <- 'none'
  }

  # Running locally? Yes = 1
  local = as.numeric(args[3])

  # If running on an HPC, set the working directory to the project home directory
  if (local == 0) {
    setwd('/home/directory/')
  }
}
```
